<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>FreightQuik â€” Dashboard</title>
<link href="https://fonts.googleapis.com/css2?family=Archivo:wght@400;600;700;800&family=JetBrains+Mono:wght@400;500&family=DM+Sans:ital,wght@0,300;0,400;0,500;1,300&display=swap" rel="stylesheet">
<script src="https://unpkg.com/react@18/umd/react.development.js"></script>
<script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prop-types/15.8.1/prop-types.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/recharts/2.8.0/Recharts.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<style>
  :root {
    --black: #080C0A; --bg: #0D1210; --bg2: #141A16; --bg3: #1C2420;
    --green: #FF6B35; --green-dim: #E85A28; --green-glow: rgba(255,107,53,0.15);
    --white: #F0F5F2; --gray: #8A9E94; --gray2: #627A6C; --border: rgba(255,255,255,0.07);
    --red: #FF5C5C; --yellow: #FFCC44; --blue: #4DAAFF;
    --mono: 'IBM Plex Mono', monospace; --display: 'Archivo', sans-serif; --body: 'Inter', sans-serif;
  }
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body { background: var(--bg); color: var(--white); font-family: var(--body); height: 100vh; overflow: hidden; }
  #root { height: 100vh; display: flex; flex-direction: column; }

  /* Scrollbar */
  ::-webkit-scrollbar { width: 4px; }
  ::-webkit-scrollbar-track { background: var(--bg2); }
  ::-webkit-scrollbar-thumb { background: var(--bg3); border-radius: 2px; }

  .btn { border: none; cursor: pointer; font-family: var(--body); transition: all 0.15s; display: inline-flex; align-items: center; gap: 6px; }
  .btn-green { background: var(--green); color: var(--black); padding: 8px 16px; border-radius: 8px; font-size: 13px; font-weight: 600; }
  .btn-green:hover { background: #2DEDA1; }
  .btn-ghost { background: transparent; color: var(--gray); padding: 8px 14px; border-radius: 8px; font-size: 13px; border: 1px solid var(--border); }
  .btn-ghost:hover { border-color: rgba(255,255,255,0.2); color: var(--white); }
  .btn-sm { padding: 5px 10px; font-size: 11px; border-radius: 6px; }

  .tag { display: inline-flex; align-items: center; gap: 4px; padding: 3px 8px; border-radius: 4px; font-family: var(--mono); font-size: 10px; font-weight: 500; }
  .tag-green { background: rgba(255,107,53,0.12); color: var(--green); }
  .tag-yellow { background: rgba(255,204,68,0.12); color: var(--yellow); }
  .tag-red { background: rgba(255,92,92,0.12); color: var(--red); }
  .tag-blue { background: rgba(77,170,255,0.12); color: var(--blue); }
  .tag-gray { background: rgba(255,255,255,0.07); color: var(--gray); }

  input, select {
    background: var(--bg3); border: 1px solid var(--border); color: var(--white);
    padding: 8px 12px; border-radius: 8px; font-family: var(--body); font-size: 13px;
    outline: none; transition: border-color 0.15s;
  }
  input:focus, select:focus { border-color: var(--green); }
  input::placeholder { color: var(--gray2); }
  select option { background: var(--bg3); }
/* â”€â”€ MOBILE RESPONSIVE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
@media (max-width: 768px) {
  .sidebar {
    display: none !important;
  }
  .mobile-nav {
    display: flex !important;
  }
  .top-bar {
    padding: 0 12px !important;
  }
  .main-content {
    padding: 12px !important;
  }
  table {
    display: block;
    overflow-x: auto;
    white-space: nowrap;
  }
  .kpi-grid {
    grid-template-columns: repeat(2, 1fr) !important;
  }
  .dispatch-grid {
    grid-template-columns: 1fr !important;
  }
}
@media (min-width: 769px) {
  .mobile-nav {
    display: none !important;
  }
}
</style>
</head>
<body>
  
</style>
</head>
<body>
<div id="root"></div>

<script type="text/babel">
const fqUser = JSON.parse(localStorage.getItem('fq_user') || 'null');
if(!fqUser) { window.location.href = 'auth.html'; }
const DEFAULT_VIEW = fqUser?.role === 'driver' ? 'inspection' : 'analytics';
const { useState, useEffect, useCallback } = React;
const API = "https://freightquick-app.onrender.com/api";

// â”€â”€ MOCK DATA (fallback when backend not running) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const MOCK = {
  drivers: [
    {id:1,username:"IGRAU",full_name:"Ivan Grau",status:"available",driver_type:"OTR",current_location:"Indianapolis, IN",loads_completed:142,on_time_rate:0.97},
    {id:2,username:"LSANCHEZ",full_name:"Luis Sanchez",status:"on_load",driver_type:"OTR",current_location:"Memphis, TN",loads_completed:218,on_time_rate:0.95},
    {id:3,username:"JTORO",full_name:"James Toro",status:"available",driver_type:"Solo",current_location:"Atlanta, GA",loads_completed:89,on_time_rate:0.93},
    {id:4,username:"MWILSON",full_name:"Mike Wilson",status:"available",driver_type:"Regional",current_location:"Tucson, AZ",loads_completed:301,on_time_rate:0.98},
    {id:5,username:"SLEONARDS",full_name:"Sarah Leonards",status:"on_load",driver_type:"OTR",current_location:"Portland, OR",loads_completed:176,on_time_rate:0.94},
    {id:6,username:"JRINALDI",full_name:"Joe Rinaldi",status:"available",driver_type:"OTR",current_location:"Salt Lake City, UT",loads_completed:203,on_time_rate:0.96},
    {id:7,username:"JABIAS",full_name:"Juan Abias",status:"available",driver_type:"OTR",current_location:"New Orleans, LA",loads_completed:155,on_time_rate:0.91},
    {id:8,username:"CSMITH",full_name:"Carol Smith",status:"off_duty",driver_type:"Solo",current_location:"Miami, FL",loads_completed:67,on_time_rate:0.99},
    {id:9,username:"DVARGAS",full_name:"David Vargas",status:"available",driver_type:"Regional",current_location:"San Diego, CA",loads_completed:412,on_time_rate:0.97},
    {id:10,username:"MRUSSO",full_name:"Marco Russo",status:"on_load",driver_type:"Regional",current_location:"Providence, RI",loads_completed:198,on_time_rate:0.92},
  ],
  loads: [
    {id:1,load_number:"010192-206",origin:"Chicago, IL",destination:"Detroit, MI",pickup_date:"2026-02-18",delivery_date:"2026-02-19",weight:42000,miles:283,rate:1850,status:"available",load_type:"OTR",commodity:"Auto Parts"},
    {id:2,load_number:"010202-476",origin:"Dallas, TX",destination:"Nashville, TN",pickup_date:"2026-02-18",delivery_date:"2026-02-20",weight:38000,miles:678,rate:2200,status:"assigned",load_type:"OTR",commodity:"Consumer Goods",driver_username:"LSANCHEZ"},
    {id:3,load_number:"010202-477",origin:"Atlanta, GA",destination:"Charlotte, NC",pickup_date:"2026-02-19",delivery_date:"2026-02-19",weight:28000,miles:244,rate:1100,status:"available",load_type:"OTR",commodity:"Electronics"},
    {id:4,load_number:"010202-478",origin:"Phoenix, AZ",destination:"Las Vegas, NV",pickup_date:"2026-02-18",delivery_date:"2026-02-18",weight:18000,miles:297,rate:950,status:"available",load_type:"Solo",commodity:"Food & Bev"},
    {id:5,load_number:"010202-479",origin:"Denver, CO",destination:"Kansas City, MO",pickup_date:"2026-02-19",delivery_date:"2026-02-20",weight:44000,miles:601,rate:2400,status:"in_transit",load_type:"Regional",commodity:"Industrial"},
    {id:6,load_number:"010202-480",origin:"Houston, TX",destination:"San Antonio, TX",pickup_date:"2026-02-18",delivery_date:"2026-02-18",weight:21000,miles:197,rate:780,status:"available",load_type:"Regional",commodity:"Chemicals"},
    {id:7,load_number:"010207-481",origin:"Seattle, WA",destination:"Sacramento, CA",pickup_date:"2026-02-20",delivery_date:"2026-02-22",weight:36000,miles:750,rate:2800,status:"assigned",load_type:"OTR",commodity:"Tech Equipment",driver_username:"SLEONARDS"},
    {id:8,load_number:"010202-321",origin:"Miami, FL",destination:"Orlando, FL",pickup_date:"2026-02-19",delivery_date:"2026-02-19",weight:28000,miles:235,rate:1050,status:"available",load_type:"OTR",commodity:"Retail Goods"},
  ],
  analytics: {
    summary:{total_drivers:10,available_drivers:5,utilization_rate:50,active_loads:7,active_assignments:2,total_revenue:890,avg_on_time_rate:95.2,total_miles:4284,total_fuel_cost:1842},
    daily_trend:[
      {date:"02/04",revenue:24000,loads:8,miles:3200},{date:"02/05",revenue:31000,loads:11,miles:4800},
      {date:"02/06",revenue:28000,loads:9,miles:3900},{date:"02/07",revenue:38000,loads:13,miles:5800},
      {date:"02/08",revenue:22000,loads:7,miles:2900},{date:"02/09",revenue:18000,loads:6,miles:2400},
      {date:"02/10",revenue:38000,loads:12,miles:5200},{date:"02/11",revenue:41000,loads:14,miles:6100},
      {date:"02/12",revenue:33000,loads:11,miles:4700},{date:"02/13",revenue:37000,loads:13,miles:5500},
      {date:"02/14",revenue:29000,loads:10,miles:4200},{date:"02/15",revenue:44000,loads:15,miles:6400},
      {date:"02/16",revenue:39000,loads:13,miles:5800},{date:"02/17",revenue:42000,loads:14,miles:6200},
    ],
    driver_utilization:[{driver_type:"OTR",total:5,active:2},{driver_type:"Regional",total:3,active:1},{driver_type:"Solo",total:2,active:0}]
  }
};

// â”€â”€ HELPERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function apiFetch(path, opts={}) {
  try {
    const companyId = fqUser?.company_id;
    const separator = path.includes("?") ? "&" : "?";
     const fullPath = companyId && !path.includes("auth") && !path.includes("superadmin") && !path.includes("stripe")
      ? `${path}${separator}company_id=${companyId}`
      : path;
    const r = await fetch(API+fullPath, {headers:{"Content-Type":"application/json"},...opts});
    return await r.json();
  } catch { return null; }
}

function StatusTag({status}) {
  const map = {available:["tag-green","AVAILABLE"],on_load:["tag-yellow","ON LOAD"],off_duty:["tag-gray","OFF DUTY"],
    in_transit:["tag-blue","IN TRANSIT"],assigned:["tag-yellow","ASSIGNED"],delivered:["tag-green","DELIVERED"]};
  const [cls,label] = map[status]||["tag-gray",status?.toUpperCase()];
  return <span className={`tag ${cls}`}>{label}</span>;
}

// â”€â”€ KPI CARD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function KpiCard({label,value,sub,color}) {
  return (
    <div style={{background:"var(--bg2)",border:"1px solid var(--border)",borderRadius:12,padding:"20px 24px"}}>
      <div style={{fontSize:11,fontFamily:"var(--mono)",color:"var(--gray)",letterSpacing:"1px",textTransform:"uppercase",marginBottom:10}}>{label}</div>
      <div style={{fontFamily:"var(--display)",fontSize:34,fontWeight:800,letterSpacing:-1.5,color:color||"var(--white)"}}>{value}</div>
      {sub && <div style={{fontSize:12,color:"var(--gray)",marginTop:6}}>{sub}</div>}
    </div>
  );
}

// â”€â”€ SIDEBAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const NAV = [
  {id:"analytics",icon:"ğŸ“Š",label:"Analytics",roles:["manager","superadmin"]},
  {id:"dispatch",icon:"ğŸš›",label:"Dispatch",roles:["manager","superadmin"]},
  {id:"loads",icon:"ğŸ“¦",label:"Loads",roles:["manager","superadmin"]},
  {id:"drivers",icon:"ğŸ‘¤",label:"Drivers",roles:["manager","superadmin"]},
  {id:"routes",icon:"ğŸ—ºï¸",label:"Routes",roles:["manager","superadmin"]},
  {id:"compliance",icon:"ğŸ“‹",label:"Compliance",roles:["manager","superadmin","driver"]},
  {id:"truckpay",icon:"ğŸ’°",label:"TruckPay",roles:["manager","superadmin","driver"]},
  {id:"insurance",icon:"ğŸ›¡ï¸",label:"Insurance",roles:["manager","superadmin"]},
  {id:"companies",icon:"ğŸ¢",label:"Companies",roles:["superadmin"]},
  {id:"inspection",icon:"ğŸšš",label:"Inspection",roles:["manager","superadmin","driver"]},
  {id:"billing",icon:"ğŸ’³",label:"Billing",roles:["manager","superadmin"]},
   {id:"settings",icon:"âš™ï¸",label:"Settings",roles:["manager","superadmin"]},
  {id:"ifta",icon:"â›½",label:"Fuel & IFTA",roles:["manager","superadmin"]},
];


function Sidebar({active,setActive}) {
  return (
    <div className="sidebar" style={{width:220,background:"var(--bg)",borderRight:"1px solid var(--border)",display:"flex",flexDirection:"column",flexShrink:0}}>
      <div style={{padding:"20px 20px 16px",borderBottom:"1px solid var(--border)"}}>
        <div style={{display:"flex",alignItems:"center",gap:8}}>
          <div style={{width:30,height:30,background:"linear-gradient(135deg, var(--green), #FF8B5A)",borderRadius:6,display:"flex",alignItems:"center",justifyContent:"center",fontSize:16,fontWeight:900,color:"var(--white)"}}>
            âš¡
          </div>
          <span style={{fontFamily:"var(--display)",fontSize:15,fontWeight:900}}>FreightQuik</span>
        </div>
      </div>
      <div style={{padding:"12px 10px",flex:1}}>
        {NAV.filter(n=>n.roles.includes(fqUser?.role)).map(n=>(
          <button key={n.id} onClick={()=>setActive(n.id)}
            style={{width:"100%",display:"flex",alignItems:"center",gap:10,padding:"10px 12px",borderRadius:8,
              background:active===n.id?"var(--green-glow)":"transparent",
              border:active===n.id?"1px solid rgba(255,107,53,0.2)":"1px solid transparent",
              color:active===n.id?"var(--green)":"var(--gray)",
              fontFamily:"var(--body)",fontSize:14,fontWeight:active===n.id?600:400,cursor:"pointer",transition:"all 0.15s",marginBottom:2}}>
            <span>{n.icon}</span>{n.label}
          </button>
        ))}
      </div>
      <div style={{padding:"16px 20px",borderTop:"1px solid var(--border)"}}>
        <div style={{display:"flex",alignItems:"center",gap:10,marginBottom:10}}>
          <div style={{width:30,height:30,borderRadius:"50%",background:"var(--bg3)",display:"flex",alignItems:"center",justifyContent:"center",fontSize:12,color:"var(--gray)"}}>
            {fqUser?.full_name?.slice(0,1)||"D"}
          </div>
          <div style={{flex:1}}>
            <div style={{fontSize:12,fontWeight:600}}>{fqUser?.full_name||"Dispatcher"}</div>
            <div style={{fontSize:10,color:"var(--gray)",fontFamily:"var(--mono)"}}>{fqUser?.role}</div>
          </div>
        </div>
        <div style={{display:"flex",gap:6}}>
          <button className="btn btn-ghost btn-sm" style={{flex:1}} onClick={()=>window.location.href="index.html"}>Home</button>
          <button className="btn btn-ghost btn-sm" style={{flex:1}} onClick={()=>{localStorage.removeItem("fq_user");window.location.href="auth.html";}}>Logout</button>
        </div>
      </div>
    </div>
  );
}
// â”€â”€ ANALYTICS VIEW â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function AnalyticsView({data}) {
  const s = data.summary;
  const {LineChart,Line,BarChart,Bar,AreaChart,XAxis,YAxis,Tooltip,ResponsiveContainer,CartesianGrid} = Recharts;
  return (
    <div style={{padding:24,overflowY:"auto",flex:1}}>
      <div style={{marginBottom:24}}>
        <div style={{fontFamily:"var(--mono)",fontSize:11,color:"var(--green)",letterSpacing:2,textTransform:"uppercase",marginBottom:8}}>Live Overview</div>
        <div style={{fontFamily:"var(--display)",fontSize:26,fontWeight:800,letterSpacing:-1}}>Operations Dashboard</div>
      </div>
      <div style={{display:"grid",gridTemplateColumns:"repeat(4,1fr)",gap:14,marginBottom:24}}>
        <KpiCard label="Driver Utilization" value={`${s.utilization_rate}%`} sub={`${s.available_drivers} available of ${s.total_drivers}`} color="var(--green)"/>
        <KpiCard label="Active Loads" value={s.active_loads} sub={`${s.active_assignments} assigned`}/>
        <KpiCard label="Avg On-Time Rate" value={`${s.avg_on_time_rate}%`} sub="Last 90 days"/>
        <KpiCard label="Total Miles Routed" value={s.total_miles.toLocaleString()} sub={`$${s.total_fuel_cost.toLocaleString()} fuel est.`}/>
      </div>
      <div style={{display:"grid",gridTemplateColumns:"2fr 1fr",gap:16}}>
        <div style={{background:"var(--bg2)",border:"1px solid var(--border)",borderRadius:12,padding:20}}>
          <div style={{fontFamily:"var(--display)",fontSize:14,fontWeight:700,marginBottom:16}}>Daily Revenue (14 Days)</div>
          <ResponsiveContainer width="100%" height={200}>
            <AreaChart data={data.daily_trend} margin={{top:0,right:0,left:-20,bottom:0}}>
              <defs>
                <linearGradient id="revGrad" x1="0" y1="0" x2="0" y2="1">
                  <stop offset="5%" stopColor="#FF6B35" stopOpacity={0.3}/>
                  <stop offset="95%" stopColor="#FF6B35" stopOpacity={0}/>
                </linearGradient>
              </defs>
              <CartesianGrid strokeDasharray="3 3" stroke="rgba(255,255,255,0.05)"/>
              <XAxis dataKey="date" tick={{fill:"#8A9E94",fontSize:10,fontFamily:"var(--mono)"}} axisLine={false} tickLine={false}/>
              <YAxis tick={{fill:"#8A9E94",fontSize:10,fontFamily:"var(--mono)"}} axisLine={false} tickLine={false} tickFormatter={v=>`$${(v/1000).toFixed(0)}k`}/>
              <Tooltip contentStyle={{background:"#1C2420",border:"1px solid rgba(255,255,255,0.1)",borderRadius:8,fontFamily:"var(--mono)",fontSize:11}} formatter={v=>[`$${v.toLocaleString()}`,"Revenue"]}/>
              <Recharts.Area type="monotone" dataKey="revenue" stroke="#FF6B35" strokeWidth={2} fill="url(#revGrad)"/>
            </AreaChart>
          </ResponsiveContainer>
        </div>
        <div style={{background:"var(--bg2)",border:"1px solid var(--border)",borderRadius:12,padding:20}}>
          <div style={{fontFamily:"var(--display)",fontSize:14,fontWeight:700,marginBottom:16}}>Driver Utilization by Type</div>
          {data.driver_utilization.map(u=>(
            <div key={u.driver_type} style={{marginBottom:16}}>
              <div style={{display:"flex",justifyContent:"space-between",marginBottom:6}}>
                <span style={{fontSize:12,fontFamily:"var(--mono)"}}>{u.driver_type}</span>
                <span style={{fontSize:12,fontFamily:"var(--mono)",color:"var(--green)"}}>{u.total>0?Math.round(u.active/u.total*100):0}%</span>
              </div>
              <div style={{height:6,background:"var(--bg3)",borderRadius:3,overflow:"hidden"}}>
                <div style={{height:"100%",width:`${u.total>0?u.active/u.total*100:0}%`,background:"var(--green)",borderRadius:3,transition:"width 0.8s ease"}}></div>
              </div>
              <div style={{fontSize:10,color:"var(--gray)",marginTop:4,fontFamily:"var(--mono)"}}>{u.active}/{u.total} active</div>
            </div>
          ))}
          <div style={{marginTop:16,padding:"12px",background:"var(--bg3)",borderRadius:8}}>
            <div style={{fontSize:10,color:"var(--gray)",fontFamily:"var(--mono)",marginBottom:4}}>LOADS THIS WEEK</div>
            <div style={{fontFamily:"var(--display)",fontSize:28,fontWeight:800,color:"var(--green)"}}>
              {data.daily_trend.slice(-7).reduce((a,d)=>a+d.loads,0)}
            </div>
          </div>
        </div>
      </div>
    </div>
  );
}
// â”€â”€ DISPATCH VIEW â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function DispatchView({drivers,loads,onAssign}) {
  const [selectedLoad,setSelectedLoad] = useState(null);
  const [selectedDrivers,setSelectedDrivers] = useState([]);
  const [matches,setMatches] = useState([]);
  const [assigning,setAssigning] = useState(false);
  const [toast,setToast] = useState(null);

  const availableLoads = loads.filter(l=>l.status==="available");
  const availableDrivers = drivers.filter(d=>d.status==="available");

  async function findMatches(loadId) {
    setSelectedLoad(loadId);
    setSelectedDrivers([]);
    const res = await apiFetch("/match",{method:"POST",body:JSON.stringify({load_id:loadId})});
    if(res?.matches) { setMatches(res.matches); }
    else {
      // mock matches
      const drv = availableDrivers.map((d,i)=>({
        ...d, match_score: +(d.on_time_rate*(0.88+Math.random()*0.12)).toFixed(2),
        match_type:["SOURCE LOAD","4 LOAD TOUR","1HR TO SOURCE","SOURCE TOUR"][i%4],
        eta_to_pickup:`${1+i}h ${Math.floor(Math.random()*59)}m`
      })).sort((a,b)=>b.match_score-a.match_score);
      setMatches(drv);
    }
  }

  function toggleDriver(id) {
    setSelectedDrivers(prev=>prev.includes(id)?prev.filter(x=>x!==id):[...prev,id]);
  }

  async function doAssign() {
    if(!selectedLoad||!selectedDrivers.length) return;
    setAssigning(true);
    for(const did of selectedDrivers) {
      await apiFetch("/assignments",{method:"POST",body:JSON.stringify({driver_id:did,load_id:selectedLoad})});
    }
    await onAssign();
    setAssigning(false);
    setToast(`âœ… ${selectedDrivers.length} driver(s) assigned successfully`);
    setSelectedLoad(null); setSelectedDrivers([]); setMatches([]);
    setTimeout(()=>setToast(null),3000);
  }

  return (
    <div style={{flex:1,display:"flex",flexDirection:"column",overflow:"hidden"}}>
      {toast && <div style={{background:"var(--green)",color:"var(--black)",padding:"10px 20px",fontFamily:"var(--mono)",fontSize:12,fontWeight:600,textAlign:"center"}}>{toast}</div>}
      <div style={{padding:24,borderBottom:"1px solid var(--border)"}}>
        <div style={{display:"flex",alignItems:"center",justifyContent:"space-between"}}>
          <div>
            <div style={{fontFamily:"var(--mono)",fontSize:11,color:"var(--green)",letterSpacing:2,textTransform:"uppercase",marginBottom:6}}>Dispatch Management</div>
            <div style={{fontFamily:"var(--display)",fontSize:22,fontWeight:800,letterSpacing:-0.8}}>Driver Assignment</div>
          </div>
          <button className="btn btn-green" onClick={doAssign} disabled={!selectedLoad||!selectedDrivers.length||assigning}
            style={{opacity:selectedLoad&&selectedDrivers.length?1:0.4}}>
            {assigning?"Assigning...":"âœ“ Assign to Driver"}
          </button>
        </div>
      </div>
      <div style={{flex:1,display:"grid",gridTemplateColumns:"1fr 1fr",overflow:"hidden"}}>
        {/* LEFT: Loads */}
        <div style={{borderRight:"1px solid var(--border)",overflowY:"auto",padding:16}}>
          <div style={{fontSize:11,fontFamily:"var(--mono)",color:"var(--gray)",letterSpacing:1,textTransform:"uppercase",marginBottom:12}}>Select Load</div>
          {availableLoads.map(l=>(
            <div key={l.id} onClick={()=>findMatches(l.id)}
              style={{padding:"14px 16px",marginBottom:8,borderRadius:10,cursor:"pointer",
                background:selectedLoad===l.id?"var(--green-glow)":"var(--bg2)",
                border:`1px solid ${selectedLoad===l.id?"rgba(255,107,53,0.4)":"var(--border)"}`,
                transition:"all 0.15s"}}>
              <div style={{display:"flex",alignItems:"center",justifyContent:"space-between",marginBottom:6}}>
                <span style={{fontFamily:"var(--mono)",fontSize:11,color:"var(--green)"}}>{l.load_number}</span>
                <StatusTag status={l.status}/>
              </div>
              <div style={{fontSize:13,fontWeight:600,marginBottom:4}}>{l.origin} â†’ {l.destination}</div>
              <div style={{display:"flex",gap:16,fontSize:11,color:"var(--gray)",fontFamily:"var(--mono)"}}>
                <span>{l.miles} mi</span>
                <span>${l.rate?.toLocaleString()}</span>
                <span>{l.load_type}</span>
                <span>{l.commodity}</span>
              </div>
            </div>
          ))}
        </div>
        {/* RIGHT: Driver Matches */}
        <div style={{overflowY:"auto",padding:16}}>
          <div style={{display:"flex",alignItems:"center",justifyContent:"space-between",marginBottom:12}}>
            <div style={{fontSize:11,fontFamily:"var(--mono)",color:"var(--gray)",letterSpacing:1,textTransform:"uppercase"}}>Optimal Matches</div>
            {selectedDrivers.length>0&&<span className="tag tag-green">{selectedDrivers.length} selected</span>}
          </div>
          {!selectedLoad && <div style={{textAlign:"center",padding:"60px 20px",color:"var(--gray)",fontSize:13}}>Select a load to see driver matches</div>}
          {matches.map(d=>(
            <div key={d.id} onClick={()=>toggleDriver(d.id)}
              style={{padding:"14px 16px",marginBottom:8,borderRadius:10,cursor:"pointer",
                background:selectedDrivers.includes(d.id)?"var(--green-glow)":"var(--bg2)",
                border:`1px solid ${selectedDrivers.includes(d.id)?"rgba(255,107,53,0.4)":"var(--border)"}`,
                transition:"all 0.15s",display:"flex",alignItems:"center",gap:12}}>
              <div style={{width:18,height:18,borderRadius:4,border:`2px solid ${selectedDrivers.includes(d.id)?"var(--green)":"var(--gray2)"}`,
                background:selectedDrivers.includes(d.id)?"var(--green)":"transparent",
                display:"flex",alignItems:"center",justifyContent:"center",flexShrink:0,transition:"all 0.1s"}}>
                {selectedDrivers.includes(d.id)&&<span style={{color:"var(--black)",fontSize:10,fontWeight:800}}>âœ“</span>}
              </div>
              <div style={{width:34,height:34,borderRadius:"50%",background:"var(--bg3)",display:"flex",alignItems:"center",justifyContent:"center",
                fontFamily:"var(--mono)",fontSize:10,color:"var(--gray)",flexShrink:0}}>
                {d.username?.slice(0,2)}
              </div>
              <div style={{flex:1}}>
                <div style={{fontWeight:600,fontSize:13,marginBottom:2}}>{d.username}</div>
                <div style={{fontSize:11,color:"var(--gray)",fontFamily:"var(--mono)"}}>{d.current_location}</div>
              </div>
              <div style={{textAlign:"right"}}>
                <div style={{display:"flex",alignItems:"center",gap:4,justifyContent:"flex-end",marginBottom:4}}>
                  <span style={{color:"var(--green)",fontSize:12}}>â˜…</span>
                  <span style={{fontFamily:"var(--mono)",fontSize:11,color:"var(--green)"}}>{d.match_type}</span>
                </div>
                <div style={{fontFamily:"var(--mono)",fontSize:10,color:"var(--gray)"}}>{d.eta_to_pickup} away</div>
                <div style={{fontFamily:"var(--mono)",fontSize:10,color:"var(--green)"}}>{Math.round((d.match_score||0)*100)}% match</div>
              </div>
            </div>
          ))}
        </div>
      </div>
    </div>
  );
}

// â”€â”€ LOADS VIEW â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function LoadsView({loads,onRefresh}) {
  const [filter,setFilter]=useState("all");
  const [search,setSearch]=useState("");
  const [showAdd,setShowAdd]=useState(false);
 

  const [form,setForm]=useState({load_number:"",origin:"",destination:"",pickup_date:"",delivery_date:"",weight:"",miles:"",rate:"",load_type:"OTR",commodity:""});

  const filtered = loads.filter(l=>{
    if(filter!=="all"&&l.status!==filter)return false;
    if(search&&!l.load_number?.includes(search)&&!l.origin?.toLowerCase().includes(search.toLowerCase())&&!l.destination?.toLowerCase().includes(search.toLowerCase()))return false;
    return true;
  });

  async function addLoad(e){
    e.preventDefault();
    await apiFetch("/loads",{method:"POST",body:JSON.stringify({...form,weight:+form.weight,miles:+form.miles,rate:+form.rate})});
    await onRefresh(); setShowAdd(false);
    setForm({load_number:"",origin:"",destination:"",pickup_date:"",delivery_date:"",weight:"",miles:"",rate:"",load_type:"OTR",commodity:""});
  }

  return (
    <div style={{flex:1,overflowY:"auto",padding:24}}>
      <div style={{display:"flex",alignItems:"center",justifyContent:"space-between",marginBottom:20}}>
        <div>
          <div style={{fontFamily:"var(--mono)",fontSize:11,color:"var(--green)",letterSpacing:2,textTransform:"uppercase",marginBottom:6}}>Load Management</div>
          <div style={{fontFamily:"var(--display)",fontSize:22,fontWeight:800,letterSpacing:-0.8}}>All Loads</div>
        </div>
        <button className="btn btn-green" onClick={()=>setShowAdd(!showAdd)}>+ Add Load</button>
      </div>

      {showAdd&&(
        <form onSubmit={addLoad} style={{background:"var(--bg2)",border:"1px solid var(--border)",borderRadius:12,padding:20,marginBottom:20}}>
          <div style={{fontFamily:"var(--display)",fontSize:15,fontWeight:700,marginBottom:16}}>New Load</div>
          <div style={{display:"grid",gridTemplateColumns:"repeat(3,1fr)",gap:12}}>
            {[["load_number","Load #"],["origin","Origin"],["destination","Destination"],["pickup_date","Pickup Date"],["delivery_date","Delivery Date"],["weight","Weight (lbs)"],["miles","Miles"],["rate","Rate ($)"],["commodity","Commodity"]].map(([k,lbl])=>(
              <div key={k}>
                <div style={{fontSize:11,color:"var(--gray)",marginBottom:4,fontFamily:"var(--mono)"}}>{lbl}</div>
                <input type={k.includes("date")?"date":k==="weight"||k==="miles"||k==="rate"?"number":"text"} value={form[k]} onChange={e=>setForm(p=>({...p,[k]:e.target.value}))} style={{width:"100%"}} required={["load_number","origin","destination"].includes(k)}/>
              </div>
            ))}
            <div>
              <div style={{fontSize:11,color:"var(--gray)",marginBottom:4,fontFamily:"var(--mono)"}}>Type</div>
              <select value={form.load_type} onChange={e=>setForm(p=>({...p,load_type:e.target.value}))} style={{width:"100%"}}>
                <option>OTR</option><option>Regional</option><option>Solo</option>
              </select>
            </div>
          </div>
          <div style={{display:"flex",gap:10,marginTop:14}}>
            <button type="submit" className="btn btn-green">Save Load</button>
            <button type="button" className="btn btn-ghost" onClick={()=>setShowAdd(false)}>Cancel</button>
          </div>
        </form>
      )}

      <div style={{display:"flex",gap:10,marginBottom:16}}>
        <input placeholder="Search loads..." value={search} onChange={e=>setSearch(e.target.value)} style={{width:220}}/>
        {["all","available","assigned","in_transit","delivered"].map(s=>(
          <button key={s} className="btn btn-ghost btn-sm" onClick={()=>setFilter(s)}
            style={{background:filter===s?"var(--green-glow)":"transparent",color:filter===s?"var(--green)":"var(--gray)",borderColor:filter===s?"rgba(255,107,53,0.3)":"var(--border)"}}>
            {s.replace("_"," ").toUpperCase()}
          </button>
        ))}
      </div>

      <div style={{background:"var(--bg2)",border:"1px solid var(--border)",borderRadius:12,overflow:"hidden"}}>
        <table style={{width:"100%",borderCollapse:"collapse"}}>
          <thead>
            <tr style={{borderBottom:"1px solid var(--border)"}}>
              {["Load #","Route","Pickup","Miles","Rate","Type","Commodity","Status","Driver"].map(h=>(
                <th key={h} style={{padding:"12px 16px",textAlign:"left",fontSize:10,fontFamily:"var(--mono)",color:"var(--gray)",letterSpacing:1,textTransform:"uppercase"}}>{h}</th>
              ))}
            </tr>
          </thead>
          <tbody>
            {filtered.map(l=>(
              <tr key={l.id} style={{borderBottom:"1px solid var(--border)",transition:"background 0.1s"}}
                onMouseEnter={e=>e.currentTarget.style.background="var(--bg3)"}
                onMouseLeave={e=>e.currentTarget.style.background="transparent"}>
                <td style={{padding:"12px 16px",fontFamily:"var(--mono)",fontSize:12,color:"var(--green)"}}>{l.load_number}</td>
                <td style={{padding:"12px 16px",fontSize:13}}>{l.origin} â†’ {l.destination}</td>
                <td style={{padding:"12px 16px",fontSize:12,fontFamily:"var(--mono)",color:"var(--gray)"}}>{l.pickup_date}</td>
                <td style={{padding:"12px 16px",fontSize:12,fontFamily:"var(--mono)"}}>{l.miles}</td>
                <td style={{padding:"12px 16px",fontSize:12,fontFamily:"var(--mono)",color:"var(--green)"}}>${l.rate?.toLocaleString()}</td>
                <td style={{padding:"12px 16px"}}><span className="tag tag-gray">{l.load_type}</span></td>
                <td style={{padding:"12px 16px",fontSize:12,color:"var(--gray)"}}>{l.commodity}</td>
                <td style={{padding:"12px 16px"}}><StatusTag status={l.status}/></td>
                <td style={{padding:"12px 16px",fontSize:12,fontFamily:"var(--mono)",color:l.driver_username?"var(--white)":"var(--gray2)"}}>{l.driver_username||"â€”"}</td>
              </tr>
            ))}
          </tbody>
        </table>
        {filtered.length===0&&<div style={{textAlign:"center",padding:"40px",color:"var(--gray)",fontSize:13}}>No loads match your filters</div>}
      </div>
    </div>
  );
}

// â”€â”€ DRIVERS VIEW â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function DriversView({drivers,onRefresh}) {
  const [showAdd,setShowAdd]=useState(false);
  const [showInvite,setShowInvite]=useState(false);
  const [search,setSearch]=useState("");
  const [form,setForm]=useState({username:"",full_name:"",driver_type:"OTR",home_base:"",current_location:""});
  const [inviteForm,setInviteForm]=useState({full_name:"",email:""});
  const [inviteResult,setInviteResult]=useState(null);
  const [inviteLoading,setInviteLoading]=useState(false);

  async function inviteDriver(e){
    e.preventDefault();
    setInviteLoading(true);
    const res = await apiFetch("/auth/invite",{method:"POST",body:JSON.stringify({
      full_name:inviteForm.full_name,
      email:inviteForm.email,
      company_id:fqUser?.company_id
    })});
    setInviteLoading(false);
    if(res?.invite_token){
      const link = `${window.location.origin}/auth.html?token=${res.invite_token}&email=${encodeURIComponent(inviteForm.email)}`;
      setInviteResult(link);
    } else {
      setInviteResult("error");
    }
  }

  async function addDriver(e){
    e.preventDefault();
    await apiFetch("/drivers",{method:"POST",body:JSON.stringify(form)});
    await onRefresh(); setShowAdd(false);
    setForm({username:"",full_name:"",driver_type:"OTR",home_base:"",current_location:""});
  }

  const filtered = drivers.filter(d=>!search||d.username?.toLowerCase().includes(search.toLowerCase())||d.full_name?.toLowerCase().includes(search.toLowerCase()));

  return (
    <div style={{flex:1,overflowY:"auto",padding:24}}>
      <div style={{display:"flex",alignItems:"center",justifyContent:"space-between",marginBottom:20}}>
        <div>
          <div style={{fontFamily:"var(--mono)",fontSize:11,color:"var(--green)",letterSpacing:2,textTransform:"uppercase",marginBottom:6}}>Driver Management</div>
          <div style={{fontFamily:"var(--display)",fontSize:22,fontWeight:800,letterSpacing:-0.8}}>All Drivers</div>
        </div>
        <div style={{display:"flex",gap:8}}>
          <button className="btn btn-ghost" onClick={()=>setShowInvite(!showInvite)}>âœ‰ Invite Driver</button>
          <button className="btn btn-green" onClick={()=>setShowAdd(!showAdd)}>+ Add Driver</button>
        </div>
      </div>

            {showInvite&&(
        <div style={{background:"var(--bg2)",border:"1px solid var(--border)",borderRadius:12,padding:20,marginBottom:20}}>
          <div style={{fontFamily:"var(--display)",fontSize:15,fontWeight:700,marginBottom:4}}>Invite Driver</div>
          <div style={{fontSize:12,color:"var(--gray)",marginBottom:16}}>Driver will receive a link to set their password and join your company.</div>
          {!inviteResult?(
            <form onSubmit={inviteDriver}>
              <div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:12,marginBottom:16}}>
                <div>
                  <div style={{fontSize:11,color:"var(--gray)",marginBottom:4,fontFamily:"var(--mono)"}}>FULL NAME</div>
                  <input value={inviteForm.full_name} onChange={e=>setInviteForm(p=>({...p,full_name:e.target.value}))} placeholder="John Smith" style={{width:"100%"}} required/>
                </div>
                <div>
                  <div style={{fontSize:11,color:"var(--gray)",marginBottom:4,fontFamily:"var(--mono)"}}>EMAIL</div>
                  <input type="email" value={inviteForm.email} onChange={e=>setInviteForm(p=>({...p,email:e.target.value}))} placeholder="driver@email.com" style={{width:"100%"}} required/>
                </div>
              </div>
              <div style={{display:"flex",gap:8}}>
                <button className="btn btn-green" type="submit" disabled={inviteLoading}>{inviteLoading?"Sending...":"Send Invite"}</button>
                <button className="btn btn-ghost" type="button" onClick={()=>{setShowInvite(false);setInviteResult(null);setInviteForm({full_name:"",email:""});}}>Cancel</button>
              </div>
            </form>
          ):(
            inviteResult==="error"?(
              <div style={{color:"var(--red)",fontSize:13}}>âŒ Error â€” email may already be registered.</div>
            ):(
              <div>
                <div style={{color:"var(--green)",fontSize:13,marginBottom:12}}>âœ… Invite created! Share this link with the driver:</div>
                <div style={{background:"var(--bg3)",border:"1px solid var(--border)",borderRadius:8,padding:12,fontFamily:"var(--mono)",fontSize:11,wordBreak:"break-all",marginBottom:12}}>{inviteResult}</div>
                <div style={{display:"flex",gap:8}}>
                  <button className="btn btn-green" onClick={()=>navigator.clipboard.writeText(inviteResult)}>ğŸ“‹ Copy Link</button>
                  <button className="btn btn-ghost" onClick={()=>{setInviteResult(null);setInviteForm({full_name:"",email:""});}}>Invite Another</button>
                </div>
              </div>
            )
          )}
        </div>
      )}
      {showAdd&&(
        <form onSubmit={addDriver} style={{background:"var(--bg2)",border:"1px solid var(--border)",borderRadius:12,padding:20,marginBottom:20}}>
          <div style={{fontFamily:"var(--display)",fontSize:15,fontWeight:700,marginBottom:16}}>New Driver</div>
          <div style={{display:"grid",gridTemplateColumns:"repeat(3,1fr)",gap:12}}>
 {[["username","Username"],["full_name","Full Name"],["home_base","Home Base"],["current_location","Current Location"]].map(([k,lbl])=>(
              <div key={k}>
                <div style={{fontSize:11,color:"var(--gray)",marginBottom:4,fontFamily:"var(--mono)"}}>{lbl}</div>
                <input value={form[k]} onChange={e=>setForm(p=>({...p,[k]:e.target.value}))} style={{width:"100%"}} required={["username","full_name"].includes(k)}/>
              </div>
            ))}
            <div>
              <div style={{fontSize:11,color:"var(--gray)",marginBottom:4,fontFamily:"var(--mono)"}}>Driver Type</div>
              <select value={form.driver_type} onChange={e=>setForm(p=>({...p,driver_type:e.target.value}))} style={{width:"100%"}}>
                <option>OTR</option><option>Regional</option><option>Solo</option>
              </select>
            </div>
          </div>
          <div style={{display:"flex",gap:10,marginTop:14}}>
            <button type="submit" className="btn btn-green">Save Driver</button>
            <button type="button" className="btn btn-ghost" onClick={()=>setShowAdd(false)}>Cancel</button>
          </div>
        </form>
      )}

      <input placeholder="Search drivers..." value={search} onChange={e=>setSearch(e.target.value)} style={{width:220,marginBottom:16}}/>

      <div style={{display:"grid",gridTemplateColumns:"repeat(auto-fill,minmax(280px,1fr))",gap:14}}>
        {filtered.map(d=>(
          <div key={d.id} style={{background:"var(--bg2)",border:"1px solid var(--border)",borderRadius:12,padding:18,transition:"border-color 0.15s"}}
            onMouseEnter={e=>e.currentTarget.style.borderColor="rgba(255,255,255,0.15)"}
            onMouseLeave={e=>e.currentTarget.style.borderColor="var(--border)"}>
            <div style={{display:"flex",alignItems:"center",gap:12,marginBottom:14}}>
              <div style={{width:40,height:40,borderRadius:"50%",background:d.status==="available"?"rgba(255,107,53,0.15)":d.status==="on_load"?"rgba(255,204,68,0.15)":"var(--bg3)",
                display:"flex",alignItems:"center",justifyContent:"center",fontFamily:"var(--mono)",fontSize:12,color:d.status==="available"?"var(--green)":d.status==="on_load"?"var(--yellow)":"var(--gray)"}}>
                {d.username?.slice(0,2)}
              </div>
              <div style={{flex:1}}>
                <div style={{fontWeight:600,fontSize:14}}>{d.username}</div>
                <div style={{fontSize:12,color:"var(--gray)"}}>{d.full_name}</div>
              </div>
              <StatusTag status={d.status}/>
            </div>
            <div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:8}}>
              <div style={{background:"var(--bg3)",borderRadius:8,padding:"8px 10px"}}>
                <div style={{fontSize:10,color:"var(--gray)",fontFamily:"var(--mono)",marginBottom:3}}>TYPE</div>
                <div style={{fontSize:13,fontWeight:600}}>{d.driver_type}</div>
              </div>
              <div style={{background:"var(--bg3)",borderRadius:8,padding:"8px 10px"}}>
                <div style={{fontSize:10,color:"var(--gray)",fontFamily:"var(--mono)",marginBottom:3}}>ON-TIME</div>
                <div style={{fontSize:13,fontWeight:600,color:"var(--green)"}}>{Math.round((d.on_time_rate||0)*100)}%</div>
              </div>
              <div style={{background:"var(--bg3)",borderRadius:8,padding:"8px 10px",gridColumn:"span 2"}}>
                <div style={{fontSize:10,color:"var(--gray)",fontFamily:"var(--mono)",marginBottom:3}}>LOCATION</div>
                <div style={{fontSize:12,truncate:true}}>{d.current_location||"Unknown"}</div>
              </div>
            </div>
            <div style={{marginTop:10,fontSize:11,color:"var(--gray)",fontFamily:"var(--mono)",textAlign:"right"}}>{d.loads_completed} loads completed</div>
          </div>
        ))}
      </div>
    </div>
  );
}

// â”€â”€ ROUTES VIEW â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function RoutesView({drivers,loads}) {
  const [routes,setRoutes] = useState([
    {id:1,load_number:"010202-476",username:"LSANCHEZ",origin:"Dallas, TX",destination:"Nashville, TN",total_miles:678,estimated_hours:12.3,fuel_cost:291,toll_cost:54,match_type:"SOURCE LOAD"},
    {id:2,load_number:"010207-481",username:"SLEONARDS",origin:"Seattle, WA",destination:"Sacramento, CA",total_miles:750,estimated_hours:13.6,fuel_cost:322,toll_cost:60,match_type:"4 LOAD TOUR"},
  ]);
  const [optimizing,setOptimizing]=useState(null);
  const [savings,setSavings]=useState({});

  async function optimize(id,assignmentId) {
    setOptimizing(id);
    const res = await apiFetch("/routes/optimize",{method:"POST",body:JSON.stringify({assignment_id:assignmentId||id})});
    if(res?.optimized) {
      setSavings(p=>({...p,[id]:{miles:res.savings_miles}}));
      setRoutes(prev=>prev.map(r=>r.id===id?{...r,total_miles:res.new_total,fuel_cost:+(res.new_total*0.43).toFixed(2)}:r));
    } else {
      // mock optimization
      const saved = +(Math.random()*40+10).toFixed(1);
      setSavings(p=>({...p,[id]:{miles:saved}}));
      setRoutes(prev=>prev.map(r=>r.id===id?{...r,total_miles:+(r.total_miles-saved).toFixed(1),fuel_cost:+((r.total_miles-saved)*0.43).toFixed(2)}:r));
    }
    setTimeout(()=>setOptimizing(null),600);
  }

  return (
    <div style={{flex:1,overflowY:"auto",padding:24}}>
      <div style={{marginBottom:24}}>
        <div style={{fontFamily:"var(--mono)",fontSize:11,color:"var(--green)",letterSpacing:2,textTransform:"uppercase",marginBottom:6}}>Route Intelligence</div>
        <div style={{fontFamily:"var(--display)",fontSize:22,fontWeight:800,letterSpacing:-0.8}}>Route Optimization</div>
      </div>

      {/* Summary Bar */}
      <div style={{display:"grid",gridTemplateColumns:"repeat(3,1fr)",gap:14,marginBottom:24}}>
        <KpiCard label="Total Miles Tracked" value={routes.reduce((a,r)=>a+r.total_miles,0).toFixed(0)} sub="Across active routes"/>
        <KpiCard label="Est. Fuel Cost" value={`$${routes.reduce((a,r)=>a+r.fuel_cost,0).toFixed(0)}`} sub="Based on $0.43/mile"/>
        <KpiCard label="Miles Optimized" value={Object.values(savings).reduce((a,s)=>a+s.miles,0).toFixed(1)} sub="Saved this session" color="var(--green)"/>
      </div>

      <div style={{display:"flex",flexDirection:"column",gap:14}}>
        {routes.map(r=>(
          <div key={r.id} style={{background:"var(--bg2)",border:"1px solid var(--border)",borderRadius:12,padding:20}}>
            <div style={{display:"flex",alignItems:"flex-start",justifyContent:"space-between",marginBottom:16}}>
              <div>
                <div style={{fontFamily:"var(--mono)",fontSize:11,color:"var(--green)",marginBottom:4}}>{r.load_number} Â· {r.match_type}</div>
                <div style={{fontFamily:"var(--display)",fontSize:18,fontWeight:700,letterSpacing:-0.5}}>{r.origin} â†’ {r.destination}</div>
                <div style={{fontSize:12,color:"var(--gray)",marginTop:4}}>Driver: {r.username}</div>
              </div>
              <button className="btn btn-green btn-sm" onClick={()=>optimize(r.id,r.assignment_id)}
                disabled={optimizing===r.id}>
                {optimizing===r.id?"âŸ³ Optimizing...":"âš¡ Optimize Route"}
              </button>
            </div>
            <div style={{display:"grid",gridTemplateColumns:"repeat(4,1fr)",gap:10}}>
              {[["Total Miles",r.total_miles+" mi"],["Est. Hours",r.estimated_hours+"h"],["Fuel Cost","$"+r.fuel_cost],["Toll Cost","$"+r.toll_cost]].map(([k,v])=>(
                <div key={k} style={{background:"var(--bg3)",borderRadius:8,padding:"10px 12px"}}>
                  <div style={{fontSize:10,color:"var(--gray)",fontFamily:"var(--mono)",marginBottom:4,letterSpacing:0.5}}>{k}</div>
                  <div style={{fontSize:16,fontWeight:700,fontFamily:"var(--display)"}}>{v}</div>
                </div>
              ))}
            </div>
            {savings[r.id]&&(
              <div style={{marginTop:12,padding:"8px 12px",background:"rgba(255,107,53,0.1)",border:"1px solid rgba(255,107,53,0.2)",borderRadius:8,
                fontFamily:"var(--mono)",fontSize:11,color:"var(--green)"}}>
                âœ“ Route optimized Â· {savings[r.id].miles} miles saved Â· ~${(savings[r.id].miles*0.43).toFixed(0)} fuel reduction
              </div>
            )}

            {/* Visual Route */}
            <div style={{marginTop:16,display:"flex",alignItems:"center",gap:0}}>
              <div style={{width:10,height:10,borderRadius:"50%",background:"var(--green)",flexShrink:0}}></div>
              <div style={{flex:1,height:2,background:"linear-gradient(90deg,var(--green),var(--green-dim))",position:"relative"}}>
                <div style={{position:"absolute",top:-16,left:"50%",transform:"translateX(-50%)",fontSize:9,fontFamily:"var(--mono)",color:"var(--gray)",whiteSpace:"nowrap"}}>{r.estimated_hours}h Â· {r.total_miles} mi</div>
                <div style={{position:"absolute",top:6,left:"30%",width:8,height:8,borderRadius:"50%",background:"var(--bg3)",border:"2px solid var(--gray2)",transform:"translateY(-50%)"}}></div>
                <div style={{position:"absolute",top:6,left:"65%",width:8,height:8,borderRadius:"50%",background:"var(--bg3)",border:"2px solid var(--gray2)",transform:"translateY(-50%)"}}></div>
              </div>
              <div style={{width:10,height:10,borderRadius:"50%",background:"var(--gray2)",flexShrink:0}}></div>
            </div>
            <div style={{display:"flex",justifyContent:"space-between",marginTop:4}}>
              <span style={{fontSize:10,fontFamily:"var(--mono)",color:"var(--green)"}}>{r.origin}</span>
              <span style={{fontSize:10,fontFamily:"var(--mono)",color:"var(--gray)"}}>{r.destination}</span>
            </div>
          </div>
        ))}
      </div>
    </div>
  );
}


// â”€â”€ COMPLIANCE VIEW â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function ComplianceView({drivers}) {
  const [records, setRecords] = useState([]);
  const [summary, setSummary] = useState({total:0,expired:0,expiring_soon:0,compliant:0});
  const [showAdd, setShowAdd] = useState(false);

  async function saveMiles(e) {
    e.preventDefault();
    setSavingMiles(true);
    const res = await apiFetch("/miles", {
      method:"POST",
      body: JSON.stringify({
        ...milesForm,
        company_id: fqUser?.company_id||1,
        miles: parseFloat(milesForm.miles),
        load_id: milesForm.load_id ? parseInt(milesForm.load_id) : null
      })
    });
    setSavingMiles(false);
    if(res?.message) {
      setToast("âœ… Miles logged!");
      setShowMiles(false);
      setMilesForm({vehicle:"",driver_name:"",state:"TX",miles:"",trip_date:new Date().toISOString().slice(0,10),load_id:""});
    } else {
      setToast("âŒ Error logging miles");
    }
    setTimeout(()=>setToast(null),3000);
  }
  const [form, setForm] = useState({driver_id:"",cdl_expiry:"",medical_card_expiry:"",drug_test_date:"",annual_inspection_expiry:"",notes:""});
  const [toast, setToast] = useState(null);

  useEffect(()=>{ loadData(); },[]);

  async function loadData() {
    const [r, s] = await Promise.all([apiFetch("/compliance"), apiFetch("/compliance/summary")]);
    if(r) setRecords(r);
    if(s) setSummary(s);
  }

  async function saveRecord(e) {
    e.preventDefault();
    await apiFetch("/compliance", {method:"POST", body:JSON.stringify({...form, driver_id:+form.driver_id})});
    await loadData();
    setShowAdd(false);
    setToast("âœ… Compliance record saved");
    setTimeout(()=>setToast(null), 3000);
  }

  function StatusBadge({status}) {
    const map = {ok:["tag-green","âœ“ OK"], expiring_soon:["tag-yellow","âš  EXPIRING"], expired:["tag-red","âœ— EXPIRED"], missing:["tag-gray","â€” MISSING"]};
    const [cls, label] = map[status]||["tag-gray","UNKNOWN"];
    return <span className={`tag ${cls}`}>{label}</span>;
  }

  return (
    <div style={{flex:1,overflowY:"auto",padding:24}}>
      {toast && <div style={{background:"var(--green)",color:"var(--black)",padding:"10px 20px",fontFamily:"var(--mono)",fontSize:12,fontWeight:600,textAlign:"center",marginBottom:16,borderRadius:8}}>{toast}</div>}
      <div style={{display:"flex",alignItems:"center",justifyContent:"space-between",marginBottom:20}}>
        <div>
          <div style={{fontFamily:"var(--mono)",fontSize:11,color:"var(--green)",letterSpacing:2,textTransform:"uppercase",marginBottom:6}}>DOT Compliance</div>
          <div style={{fontFamily:"var(--display)",fontSize:22,fontWeight:800,letterSpacing:-0.8}}>Compliance Manager</div>
        </div>
        <button className="btn btn-green" onClick={()=>setShowAdd(!showAdd)}>+ Add Record</button>
      </div>

      {/* Summary Cards */}
      <div style={{display:"grid",gridTemplateColumns:"repeat(4,1fr)",gap:14,marginBottom:24}}>
        <KpiCard label="Total Records" value={summary.total} sub="Drivers tracked"/>
        <KpiCard label="Compliant" value={summary.compliant} sub="All docs valid" color="var(--green)"/>
        <KpiCard label="Expiring Soon" value={summary.expiring_soon} sub="Within 30 days" color="var(--yellow)"/>
        <KpiCard label="Expired" value={summary.expired} sub="Needs attention" color="var(--red)"/>
      </div>

      {/* Add Form */}
      {showAdd && (
        <form onSubmit={saveRecord} style={{background:"var(--bg2)",border:"1px solid var(--border)",borderRadius:12,padding:20,marginBottom:20}}>
          <div style={{fontFamily:"var(--display)",fontSize:15,fontWeight:700,marginBottom:16}}>New Compliance Record</div>
          <div style={{display:"grid",gridTemplateColumns:"repeat(3,1fr)",gap:12}}>
            <div>
              <div style={{fontSize:11,color:"var(--gray)",marginBottom:4,fontFamily:"var(--mono)"}}>DRIVER</div>
              <select value={form.driver_id} onChange={e=>setForm(p=>({...p,driver_id:e.target.value}))} style={{width:"100%"}} required>
                <option value="">Select driver...</option>
                {drivers.map(d=><option key={d.id} value={d.id}>{d.username} â€” {d.full_name}</option>)}
              </select>
            </div>
            {[["cdl_expiry","CDL Expiry"],["medical_card_expiry","Medical Card Expiry"],["drug_test_date","Last Drug Test"],["annual_inspection_expiry","Annual Inspection Expiry"]].map(([k,lbl])=>(
              <div key={k}>
                <div style={{fontSize:11,color:"var(--gray)",marginBottom:4,fontFamily:"var(--mono)"}}>{lbl.toUpperCase()}</div>
                <input type="date" value={form[k]} onChange={e=>setForm(p=>({...p,[k]:e.target.value}))} style={{width:"100%"}}/>
              </div>
            ))}
            <div>
              <div style={{fontSize:11,color:"var(--gray)",marginBottom:4,fontFamily:"var(--mono)"}}>NOTES</div>
              <input value={form.notes} onChange={e=>setForm(p=>({...p,notes:e.target.value}))} style={{width:"100%"}} placeholder="Optional notes..."/>
            </div>
          </div>
          <div style={{display:"flex",gap:10,marginTop:14}}>
            <button type="submit" className="btn btn-green">Save Record</button>
            <button type="button" className="btn btn-ghost" onClick={()=>setShowAdd(false)}>Cancel</button>
          </div>
        </form>
      )}

      {/* Records Table */}
      <div style={{background:"var(--bg2)",border:"1px solid var(--border)",borderRadius:12,overflow:"hidden"}}>
        <table style={{width:"100%",borderCollapse:"collapse"}}>
          <thead>
            <tr style={{borderBottom:"1px solid var(--border)"}}>
              {["Driver","Type","CDL","Medical Card","Drug Test","Annual Inspection","Notes"].map(h=>(
                <th key={h} style={{padding:"12px 16px",textAlign:"left",fontSize:10,fontFamily:"var(--mono)",color:"var(--gray)",letterSpacing:1,textTransform:"uppercase"}}>{h}</th>
              ))}
            </tr>
          </thead>
          <tbody>
            {records.map(r=>(
              <tr key={r.id} style={{borderBottom:"1px solid var(--border)"}}
                onMouseEnter={e=>e.currentTarget.style.background="var(--bg3)"}
                onMouseLeave={e=>e.currentTarget.style.background="transparent"}>
                <td style={{padding:"12px 16px"}}>
                  <div style={{fontWeight:600,fontSize:13}}>{r.username}</div>
                  <div style={{fontSize:11,color:"var(--gray)"}}>{r.full_name}</div>
                </td>
                <td style={{padding:"12px 16px"}}><span className="tag tag-gray">{r.driver_type}</span></td>
                <td style={{padding:"12px 16px"}}>
                  <StatusBadge status={r.cdl_status}/>
                  <div style={{fontSize:10,color:"var(--gray)",fontFamily:"var(--mono)",marginTop:3}}>{r.cdl_expiry||"â€”"}</div>
                </td>
                <td style={{padding:"12px 16px"}}>
                  <StatusBadge status={r.medical_status}/>
                  <div style={{fontSize:10,color:"var(--gray)",fontFamily:"var(--mono)",marginTop:3}}>{r.medical_card_expiry||"â€”"}</div>
                </td>
                <td style={{padding:"12px 16px"}}>
                  <StatusBadge status={r.drug_test_status}/>
                  <div style={{fontSize:10,color:"var(--gray)",fontFamily:"var(--mono)",marginTop:3}}>{r.drug_test_date||"â€”"}</div>
                </td>
                <td style={{padding:"12px 16px"}}>
                  <StatusBadge status={r.inspection_status}/>
                  <div style={{fontSize:10,color:"var(--gray)",fontFamily:"var(--mono)",marginTop:3}}>{r.annual_inspection_expiry||"â€”"}</div>
                </td>
                <td style={{padding:"12px 16px",fontSize:12,color:"var(--gray)"}}>{r.notes||"â€”"}</td>
              </tr>
            ))}
          </tbody>
        </table>
        {records.length===0&&<div style={{textAlign:"center",padding:"40px",color:"var(--gray)",fontSize:13}}>No compliance records yet. Click + Add Record to get started.</div>}
      </div>
    </div>
  );
}

// â”€â”€ TRUCKPAY VIEW â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function TruckPayView({drivers}) {
  const [records, setRecords] = useState([]);
  const [summary, setSummary] = useState({total_gross:0,total_deductions:0,total_net:0,total_records:0});
  const [showAdd, setShowAdd] = useState(false);
  const [toast, setToast] = useState(null);
  const [form, setForm] = useState({driver_id:"",week_ending:"",gross_pay:"",fuel_deduction:"0",insurance_deduction:"0",advance_deduction:"0",other_deduction:"0",notes:""});

  useEffect(()=>{ loadData(); },[]);

  async function loadData() {
    const [r, s] = await Promise.all([apiFetch("/pay"), apiFetch("/pay/summary")]);
    if(r) setRecords(r);
    if(s) setSummary(s);
  }

  async function exportPDF(r) {
    const {jsPDF} = window.jspdf;
    const doc = new jsPDF();
    const orange = [255,107,53];
    const dark = [13,18,16];

    // Load company settings
    const settings = await apiFetch(`/settings/${fqUser?.company_id}`);
    const companyName = settings?.company_name || fqUser?.company_name || "FreightQuik";
    const companyAddress = settings?.address ? `${settings.address}, ${settings.city||""} ${settings.state||""} ${settings.zip_code||""}` : "";
    const companyPhone = settings?.phone || "";
    const companyEmail = settings?.email || "";
    const companyDOT = settings?.dot_number || "";
    const companyMC = settings?.mc_number || "";

    // Header
    doc.setFillColor(...orange);
    doc.rect(0,0,210,28,"F");
    doc.setTextColor(255,255,255);

    // Add logo if exists
    if(settings?.logo_base64) {
      try {
        doc.addImage(settings.logo_base64, "JPEG", 14, 3, 18, 18);
        doc.setFontSize(16);
        doc.setFont("helvetica","bold");
        doc.text(companyName, 36, 10);
        doc.setFontSize(9);
        doc.setFont("helvetica","normal");
        doc.text("Driver Settlement Sheet", 36, 17);
        doc.text(`Generated: ${new Date().toLocaleDateString()}`, 140, 10);
      } catch(e) {
        doc.setFontSize(20);
        doc.setFont("helvetica","bold");
        doc.text(companyName, 14, 12);
      }
    } else {
      doc.setFontSize(20);
      doc.setFont("helvetica","bold");
      doc.text(companyName, 14, 12);
    }

    doc.setFontSize(10);
    doc.setFont("helvetica","normal");

    // Driver Info Box
    doc.setFillColor(240,245,242);
    doc.rect(14,34,182,30,"F");
    doc.setTextColor(...dark);
    doc.setFontSize(11);
    doc.setFont("helvetica","bold");
    doc.text("DRIVER INFORMATION",18,44);
    doc.setFont("helvetica","normal");
    doc.setFontSize(10);
    doc.text(`Name: ${r.full_name}`,18,52);
    doc.text(`Username: ${r.username}`,18,58);
    doc.text(`Week Ending: ${r.week_ending}`,110,52);
    doc.text(`Driver Type: ${r.driver_type}`,110,58);

    // Pay Summary
    doc.setFontSize(12);
    doc.setFont("helvetica","bold");
    doc.setTextColor(...orange);
    doc.text("PAY SUMMARY",14,78);

    const rows = [
      ["Gross Pay", `$${r.gross_pay?.toLocaleString()}`],
      ["Fuel Deduction", `-$${r.fuel_deduction?.toLocaleString()}`],
      ["Insurance Deduction", `-$${r.insurance_deduction?.toLocaleString()}`],
      ["Advance Deduction", `-$${r.advance_deduction?.toLocaleString()}`],
      ["Other Deduction", `-$${r.other_deduction?.toLocaleString()}`],
    ];

    let y = 86;
    doc.setFont("helvetica","normal");
    doc.setFontSize(10);
    rows.forEach(([label,value],i)=>{
      doc.setFillColor(i%2===0?248:255,i%2===0?248:255,i%2===0?248:255);
      doc.rect(14,y-5,182,10,"F");
      doc.setTextColor(...dark);
      doc.text(label,18,y);
      doc.text(value,170,y,"right");
      y+=12;
    });

    // Net Pay
    doc.setFillColor(...orange);
    doc.rect(14,y-2,182,14,"F");
    doc.setTextColor(255,255,255);
    doc.setFontSize(13);
    doc.setFont("helvetica","bold");
    doc.text("NET PAY",18,y+7);
    doc.text(`$${r.net_pay?.toLocaleString()}`,192,y+7,"right");
    y+=22;

    // Notes
    if(r.notes) {
      doc.setTextColor(...dark);
      doc.setFontSize(10);
      doc.setFont("helvetica","bold");
      doc.text("NOTES:",14,y+6);
      doc.setFont("helvetica","normal");
      doc.text(r.notes,14,y+14);
      y+=20;
    }

    // Footer
    doc.setFillColor(220,225,222);
    doc.rect(0,275,210,22,"F");
    doc.setTextColor(100,120,110);
    doc.setFontSize(8);
    doc.setFont("helvetica","normal");
    doc.text(companyName,14,281);
    if(companyAddress) doc.text(companyAddress,14,286);
    if(companyPhone) doc.text(`Tel: ${companyPhone}`,14,291);
    if(companyDOT) doc.text(`DOT: ${companyDOT}`,120,281);
    if(companyMC) doc.text(`MC: ${companyMC}`,120,286);
    doc.text(`Settlement ID: FQ-${r.id}-${r.week_ending}`,120,291);

    doc.save(`Settlement_${r.username}_${r.week_ending}.pdf`);
  }
  async function saveRecord(e) {
    e.preventDefault();
    await apiFetch("/pay", {method:"POST", body:JSON.stringify({
      ...form,
      driver_id:+form.driver_id,
      gross_pay:+form.gross_pay,
      fuel_deduction:+form.fuel_deduction,
      insurance_deduction:+form.insurance_deduction,
      advance_deduction:+form.advance_deduction,
      other_deduction:+form.other_deduction
    })});
    await loadData();
    setShowAdd(false);
    setToast("âœ… Pay record saved");
    setTimeout(()=>setToast(null), 3000);
    setForm({driver_id:"",week_ending:"",gross_pay:"",fuel_deduction:"0",insurance_deduction:"0",advance_deduction:"0",other_deduction:"0",notes:""});
  }

  return (
    <div style={{flex:1,overflowY:"auto",padding:24}}>
      {toast && <div style={{background:"var(--green)",color:"var(--black)",padding:"10px 20px",fontFamily:"var(--mono)",fontSize:12,fontWeight:600,textAlign:"center",marginBottom:16,borderRadius:8}}>{toast}</div>}
      <div style={{display:"flex",alignItems:"center",justifyContent:"space-between",marginBottom:20}}>
        <div>
          <div style={{fontFamily:"var(--mono)",fontSize:11,color:"var(--green)",letterSpacing:2,textTransform:"uppercase",marginBottom:6}}>Driver Payments</div>
          <div style={{fontFamily:"var(--display)",fontSize:22,fontWeight:800,letterSpacing:-0.8}}>TruckPay â€” Settlement Tracker</div>
        </div>
        <button className="btn btn-green" onClick={()=>setShowAdd(!showAdd)}>+ Add Settlement</button>
      </div>

      {/* Summary Cards */}
      <div style={{display:"grid",gridTemplateColumns:"repeat(4,1fr)",gap:14,marginBottom:24}}>
        <KpiCard label="Total Records" value={summary.total_records} sub="All settlements"/>
        <KpiCard label="Total Gross Pay" value={`$${summary.total_gross?.toLocaleString()}`} sub="Before deductions"/>
        <KpiCard label="Total Deductions" value={`$${summary.total_deductions?.toLocaleString()}`} sub="Fuel, insurance, advances" color="var(--red)"/>
        <KpiCard label="Total Net Pay" value={`$${summary.total_net?.toLocaleString()}`} sub="Driver take home" color="var(--green)"/>
      </div>

      {/* Add Form */}
      {showAdd && (
        <form onSubmit={saveRecord} style={{background:"var(--bg2)",border:"1px solid var(--border)",borderRadius:12,padding:20,marginBottom:20}}>
          <div style={{fontFamily:"var(--display)",fontSize:15,fontWeight:700,marginBottom:16}}>New Settlement</div>
          <div style={{display:"grid",gridTemplateColumns:"repeat(3,1fr)",gap:12}}>
            <div>
              <div style={{fontSize:11,color:"var(--gray)",marginBottom:4,fontFamily:"var(--mono)"}}>DRIVER</div>
              <select value={form.driver_id} onChange={e=>setForm(p=>({...p,driver_id:e.target.value}))} style={{width:"100%"}} required>
                <option value="">Select driver...</option>
                {drivers.map(d=><option key={d.id} value={d.id}>{d.username} â€” {d.full_name}</option>)}
              </select>
            </div>
            <div>
              <div style={{fontSize:11,color:"var(--gray)",marginBottom:4,fontFamily:"var(--mono)"}}>WEEK ENDING</div>
              <input type="date" value={form.week_ending} onChange={e=>setForm(p=>({...p,week_ending:e.target.value}))} style={{width:"100%"}} required/>
            </div>
            <div>
              <div style={{fontSize:11,color:"var(--gray)",marginBottom:4,fontFamily:"var(--mono)"}}>GROSS PAY ($)</div>
              <input type="number" value={form.gross_pay} onChange={e=>setForm(p=>({...p,gross_pay:e.target.value}))} style={{width:"100%"}} required placeholder="0"/>
            </div>
            {[["fuel_deduction","Fuel Deduction ($)"],["insurance_deduction","Insurance ($)"],["advance_deduction","Advance ($)"],["other_deduction","Other Deduction ($)"]].map(([k,lbl])=>(
              <div key={k}>
                <div style={{fontSize:11,color:"var(--gray)",marginBottom:4,fontFamily:"var(--mono)"}}>{lbl.toUpperCase()}</div>
                <input type="number" value={form[k]} onChange={e=>setForm(p=>({...p,[k]:e.target.value}))} style={{width:"100%"}} placeholder="0"/>
              </div>
            ))}
            <div>
              <div style={{fontSize:11,color:"var(--gray)",marginBottom:4,fontFamily:"var(--mono)"}}>NOTES</div>
              <input value={form.notes} onChange={e=>setForm(p=>({...p,notes:e.target.value}))} style={{width:"100%"}} placeholder="Optional..."/>
            </div>
          </div>
          <div style={{display:"flex",gap:10,marginTop:14}}>
            <button type="submit" className="btn btn-green">Save Settlement</button>
            <button type="button" className="btn btn-ghost" onClick={()=>setShowAdd(false)}>Cancel</button>
          </div>
        </form>
      )}

      {/* Records Table */}
      <div style={{background:"var(--bg2)",border:"1px solid var(--border)",borderRadius:12,overflow:"hidden"}}>
        <table style={{width:"100%",borderCollapse:"collapse"}}>
          <thead>
            <tr style={{borderBottom:"1px solid var(--border)"}}>
                {["Driver","Week Ending","Gross Pay","Deductions","Net Pay","Notes",""].map(h=>(
                <th key={h} style={{padding:"12px 16px",textAlign:"left",fontSize:10,fontFamily:"var(--mono)",color:"var(--gray)",letterSpacing:1,textTransform:"uppercase"}}>{h}</th>
              ))}
            </tr>
          </thead>
          <tbody>
            {records.map(r=>(
              <tr key={r.id} style={{borderBottom:"1px solid var(--border)"}}
                onMouseEnter={e=>e.currentTarget.style.background="var(--bg3)"}
                onMouseLeave={e=>e.currentTarget.style.background="transparent"}>
                <td style={{padding:"12px 16px"}}>
                  <div style={{fontWeight:600,fontSize:13}}>{r.username}</div>
                  <div style={{fontSize:11,color:"var(--gray)"}}>{r.full_name}</div>
                </td>
                <td style={{padding:"12px 16px",fontFamily:"var(--mono)",fontSize:12,color:"var(--gray)"}}>{r.week_ending}</td>
                <td style={{padding:"12px 16px",fontFamily:"var(--mono)",fontSize:13,color:"var(--white)"}}>${r.gross_pay?.toLocaleString()}</td>
                <td style={{padding:"12px 16px",fontFamily:"var(--mono)",fontSize:13,color:"var(--red)"}}>-${r.total_deductions?.toLocaleString()}</td>
                <td style={{padding:"12px 16px",fontFamily:"var(--mono)",fontSize:13,fontWeight:700,color:"var(--green)"}}>${r.net_pay?.toLocaleString()}</td>
               <td style={{padding:"12px 16px",fontSize:12,color:"var(--gray)"}}>{r.notes||"â€”"}</td>
                <td style={{padding:"12px 16px"}}><button className="btn btn-ghost btn-sm" onClick={()=>exportPDF(r)}>â¬‡ PDF</button></td>
              </tr>
            ))}
          </tbody>
        </table>
        {records.length===0&&<div style={{textAlign:"center",padding:"40px",color:"var(--gray)",fontSize:13}}>No settlements yet. Click + Add Settlement to get started.</div>}
      </div>
    </div>
  );
}

// â”€â”€ MAINTENANCE VIEW â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function MaintenanceView() {
  const [records, setRecords] = useState([]);
  const [summary, setSummary] = useState({total:0,overdue:0,due_soon:0,ok:0,total_cost:0});
  const [showAdd, setShowAdd] = useState(false);
  const [toast, setToast] = useState(null);
  const [form, setForm] = useState({truck_number:"",maintenance_type:"Oil Change",last_service_date:"",next_service_date:"",mileage:"",cost:"",notes:""});

  useEffect(()=>{ loadData(); },[]);

  async function loadData() {
    const [r, s] = await Promise.all([apiFetch("/maintenance"), apiFetch("/maintenance/summary")]);
    if(r) setRecords(r);
    if(s) setSummary(s);
  }

  async function saveRecord(e) {
    e.preventDefault();
    await apiFetch("/maintenance", {method:"POST", body:JSON.stringify({
      ...form, mileage:+form.mileage, cost:+form.cost
    })});
    await loadData();
    setShowAdd(false);
    setToast("âœ… Maintenance record saved");
    setTimeout(()=>setToast(null), 3000);
    setForm({truck_number:"",maintenance_type:"Oil Change",last_service_date:"",next_service_date:"",mileage:"",cost:"",notes:""});
  }

  function StatusBadge({status}) {
    const map = {ok:["tag-green","âœ“ OK"],due_soon:["tag-yellow","âš  DUE SOON"],overdue:["tag-red","âœ— OVERDUE"],missing:["tag-gray","â€” MISSING"]};
    const [cls,label] = map[status]||["tag-gray","UNKNOWN"];
    return <span className={`tag ${cls}`}>{label}</span>;
  }

  return (
    <div style={{flex:1,overflowY:"auto",padding:24}}>
      {toast && <div style={{background:"var(--green)",color:"var(--black)",padding:"10px 20px",fontFamily:"var(--mono)",fontSize:12,fontWeight:600,textAlign:"center",marginBottom:16,borderRadius:8}}>{toast}</div>}
      <div style={{display:"flex",alignItems:"center",justifyContent:"space-between",marginBottom:20}}>
        <div>
          <div style={{fontFamily:"var(--mono)",fontSize:11,color:"var(--green)",letterSpacing:2,textTransform:"uppercase",marginBottom:6}}>Fleet Maintenance</div>
          <div style={{fontFamily:"var(--display)",fontSize:22,fontWeight:800,letterSpacing:-0.8}}>TruckMaintenance Pro</div>
        </div>
        <button className="btn btn-green" onClick={()=>setShowAdd(!showAdd)}>+ Add Record</button>
      </div>

      {/* Summary Cards */}
      <div style={{display:"grid",gridTemplateColumns:"repeat(5,1fr)",gap:14,marginBottom:24}}>
        <KpiCard label="Total Records" value={summary.total} sub="All trucks"/>
        <KpiCard label="OK" value={summary.ok} sub="No action needed" color="var(--green)"/>
        <KpiCard label="Due Soon" value={summary.due_soon} sub="Within 14 days" color="var(--yellow)"/>
        <KpiCard label="Overdue" value={summary.overdue} sub="Needs attention" color="var(--red)"/>
        <KpiCard label="Total Repair Cost" value={`$${summary.total_cost?.toLocaleString()}`} sub="All time"/>
      </div>

      {/* Add Form */}
      {showAdd && (
        <form onSubmit={saveRecord} style={{background:"var(--bg2)",border:"1px solid var(--border)",borderRadius:12,padding:20,marginBottom:20}}>
          <div style={{fontFamily:"var(--display)",fontSize:15,fontWeight:700,marginBottom:16}}>New Maintenance Record</div>
          <div style={{display:"grid",gridTemplateColumns:"repeat(3,1fr)",gap:12}}>
            <div>
              <div style={{fontSize:11,color:"var(--gray)",marginBottom:4,fontFamily:"var(--mono)"}}>TRUCK NUMBER</div>
              <input value={form.truck_number} onChange={e=>setForm(p=>({...p,truck_number:e.target.value}))} style={{width:"100%"}} placeholder="e.g. TRK-001" required/>
            </div>
            <div>
              <div style={{fontSize:11,color:"var(--gray)",marginBottom:4,fontFamily:"var(--mono)"}}>MAINTENANCE TYPE</div>
              <select value={form.maintenance_type} onChange={e=>setForm(p=>({...p,maintenance_type:e.target.value}))} style={{width:"100%"}}>
                <option>Oil Change</option>
                <option>Tire Replacement</option>
                <option>Brake Service</option>
                <option>Engine Repair</option>
                <option>Annual Inspection</option>
                <option>Transmission Service</option>
                <option>Other</option>
              </select>
            </div>
            <div>
              <div style={{fontSize:11,color:"var(--gray)",marginBottom:4,fontFamily:"var(--mono)"}}>MILEAGE</div>
              <input type="number" value={form.mileage} onChange={e=>setForm(p=>({...p,mileage:e.target.value}))} style={{width:"100%"}} placeholder="0"/>
            </div>
            <div>
              <div style={{fontSize:11,color:"var(--gray)",marginBottom:4,fontFamily:"var(--mono)"}}>LAST SERVICE DATE</div>
              <input type="date" value={form.last_service_date} onChange={e=>setForm(p=>({...p,last_service_date:e.target.value}))} style={{width:"100%"}} required/>
            </div>
            <div>
              <div style={{fontSize:11,color:"var(--gray)",marginBottom:4,fontFamily:"var(--mono)"}}>NEXT SERVICE DATE</div>
              <input type="date" value={form.next_service_date} onChange={e=>setForm(p=>({...p,next_service_date:e.target.value}))} style={{width:"100%"}} required/>
            </div>
            <div>
              <div style={{fontSize:11,color:"var(--gray)",marginBottom:4,fontFamily:"var(--mono)"}}>COST ($)</div>
              <input type="number" value={form.cost} onChange={e=>setForm(p=>({...p,cost:e.target.value}))} style={{width:"100%"}} placeholder="0"/>
            </div>
            <div style={{gridColumn:"span 3"}}>
              <div style={{fontSize:11,color:"var(--gray)",marginBottom:4,fontFamily:"var(--mono)"}}>NOTES</div>
              <input value={form.notes} onChange={e=>setForm(p=>({...p,notes:e.target.value}))} style={{width:"100%"}} placeholder="Optional notes..."/>
            </div>
          </div>
          <div style={{display:"flex",gap:10,marginTop:14}}>
            <button type="submit" className="btn btn-green">Save Record</button>
            <button type="button" className="btn btn-ghost" onClick={()=>setShowAdd(false)}>Cancel</button>
          </div>
        </form>
      )}

      {/* Records Table */}
      <div style={{background:"var(--bg2)",border:"1px solid var(--border)",borderRadius:12,overflow:"hidden"}}>
        <table style={{width:"100%",borderCollapse:"collapse"}}>
          <thead>
            <tr style={{borderBottom:"1px solid var(--border)"}}>
              {["Truck","Type","Last Service","Next Service","Mileage","Cost","Status","Notes"].map(h=>(
                <th key={h} style={{padding:"12px 16px",textAlign:"left",fontSize:10,fontFamily:"var(--mono)",color:"var(--gray)",letterSpacing:1,textTransform:"uppercase"}}>{h}</th>
              ))}
            </tr>
          </thead>
          <tbody>
            {records.map(r=>(
              <tr key={r.id} style={{borderBottom:"1px solid var(--border)"}}
                onMouseEnter={e=>e.currentTarget.style.background="var(--bg3)"}
                onMouseLeave={e=>e.currentTarget.style.background="transparent"}>
                <td style={{padding:"12px 16px",fontFamily:"var(--mono)",fontSize:13,fontWeight:700,color:"var(--green)"}}>{r.truck_number}</td>
                <td style={{padding:"12px 16px"}}><span className="tag tag-blue">{r.maintenance_type}</span></td>
                <td style={{padding:"12px 16px",fontFamily:"var(--mono)",fontSize:12,color:"var(--gray)"}}>{r.last_service_date}</td>
                <td style={{padding:"12px 16px",fontFamily:"var(--mono)",fontSize:12}}>{r.next_service_date}</td>
                <td style={{padding:"12px 16px",fontFamily:"var(--mono)",fontSize:12}}>{r.mileage?.toLocaleString()} mi</td>
                <td style={{padding:"12px 16px",fontFamily:"var(--mono)",fontSize:12,color:"var(--yellow)"}}>${r.cost?.toLocaleString()}</td>
                <td style={{padding:"12px 16px"}}><StatusBadge status={r.status}/></td>
                <td style={{padding:"12px 16px",fontSize:12,color:"var(--gray)"}}>{r.notes||"â€”"}</td>
              </tr>
            ))}
          </tbody>
        </table>
        {records.length===0&&<div style={{textAlign:"center",padding:"40px",color:"var(--gray)",fontSize:13}}>No maintenance records yet. Click + Add Record to get started.</div>}
      </div>
    </div>
  );
}

// â”€â”€ FUEL MANAGER VIEW â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function FuelManagerView({drivers}) {
  const [records, setRecords] = useState([]);
  const [summary, setSummary] = useState({total_records:0,total_gallons:0,total_cost:0,avg_price_per_gallon:0});
  const [showAdd, setShowAdd] = useState(false);
  const [toast, setToast] = useState(null);
  const [form, setForm] = useState({truck_number:"",driver_id:"",date:"",gallons:"",price_per_gallon:"",location:"",odometer:"",notes:""});

  useEffect(()=>{ loadData(); },[]);

  async function loadData() {
    const [r, s] = await Promise.all([apiFetch("/fuel"), apiFetch("/fuel/summary")]);
    if(r && Array.isArray(r)) setRecords(r);
    if(s) setSummary(s);
  }

  async function saveRecord(e) {
    e.preventDefault();
    await apiFetch("/fuel", {method:"POST", body:JSON.stringify({
      ...form,
      driver_id: form.driver_id ? +form.driver_id : null,
      gallons:+form.gallons,
      price_per_gallon:+form.price_per_gallon,
      odometer:+form.odometer
    })});
    await loadData();
    setShowAdd(false);
    setToast("âœ… Fuel record saved");
    setTimeout(()=>setToast(null), 3000);
    setForm({truck_number:"",driver_id:"",date:"",gallons:"",price_per_gallon:"",location:"",odometer:"",notes:""});
  }

  return (
    <div style={{flex:1,overflowY:"auto",padding:24}}>
      {toast && <div style={{background:"var(--green)",color:"var(--black)",padding:"10px 20px",fontFamily:"var(--mono)",fontSize:12,fontWeight:600,textAlign:"center",marginBottom:16,borderRadius:8}}>{toast}</div>}
      <div style={{display:"flex",alignItems:"center",justifyContent:"space-between",marginBottom:20}}>
        <div>
          <div style={{fontFamily:"var(--mono)",fontSize:11,color:"var(--green)",letterSpacing:2,textTransform:"uppercase",marginBottom:6}}>Fuel Tracking</div>
          <div style={{fontFamily:"var(--display)",fontSize:22,fontWeight:800,letterSpacing:-0.8}}>Fuel Card Manager</div>
        </div>
        <button className="btn btn-green" onClick={()=>setShowAdd(!showAdd)}>+ Add Fuel Record</button>
      </div>

      {/* Summary Cards */}
      <div style={{display:"grid",gridTemplateColumns:"repeat(4,1fr)",gap:14,marginBottom:24}}>
        <KpiCard label="Total Transactions" value={summary.total_records} sub="All fuel stops"/>
        <KpiCard label="Total Gallons" value={summary.total_gallons?.toLocaleString()} sub="Purchased"/>
        <KpiCard label="Total Fuel Cost" value={`$${summary.total_cost?.toLocaleString()}`} sub="All time" color="var(--red)"/>
        <KpiCard label="Avg Price/Gallon" value={`$${summary.avg_price_per_gallon}`} sub="Fleet average" color="var(--yellow)"/>
      </div>

      {/* Add Form */}
      {showAdd && (
        <form onSubmit={saveRecord} style={{background:"var(--bg2)",border:"1px solid var(--border)",borderRadius:12,padding:20,marginBottom:20}}>
          <div style={{fontFamily:"var(--display)",fontSize:15,fontWeight:700,marginBottom:16}}>New Fuel Record</div>
          <div style={{display:"grid",gridTemplateColumns:"repeat(3,1fr)",gap:12}}>
            <div>
              <div style={{fontSize:11,color:"var(--gray)",marginBottom:4,fontFamily:"var(--mono)"}}>TRUCK NUMBER</div>
              <input value={form.truck_number} onChange={e=>setForm(p=>({...p,truck_number:e.target.value}))} style={{width:"100%"}} placeholder="e.g. TRK-001" required/>
            </div>
            <div>
              <div style={{fontSize:11,color:"var(--gray)",marginBottom:4,fontFamily:"var(--mono)"}}>DRIVER (OPTIONAL)</div>
              <select value={form.driver_id} onChange={e=>setForm(p=>({...p,driver_id:e.target.value}))} style={{width:"100%"}}>
                <option value="">Select driver...</option>
                {drivers.map(d=><option key={d.id} value={d.id}>{d.username} â€” {d.full_name}</option>)}
              </select>
            </div>
            <div>
              <div style={{fontSize:11,color:"var(--gray)",marginBottom:4,fontFamily:"var(--mono)"}}>DATE</div>
              <input type="date" value={form.date} onChange={e=>setForm(p=>({...p,date:e.target.value}))} style={{width:"100%"}} required/>
            </div>
            <div>
              <div style={{fontSize:11,color:"var(--gray)",marginBottom:4,fontFamily:"var(--mono)"}}>GALLONS</div>
              <input type="number" step="0.01" value={form.gallons} onChange={e=>setForm(p=>({...p,gallons:e.target.value}))} style={{width:"100%"}} placeholder="0.00" required/>
            </div>
            <div>
              <div style={{fontSize:11,color:"var(--gray)",marginBottom:4,fontFamily:"var(--mono)"}}>PRICE PER GALLON ($)</div>
              <input type="number" step="0.001" value={form.price_per_gallon} onChange={e=>setForm(p=>({...p,price_per_gallon:e.target.value}))} style={{width:"100%"}} placeholder="0.000" required/>
            </div>
            <div>
              <div style={{fontSize:11,color:"var(--gray)",marginBottom:4,fontFamily:"var(--mono)"}}>ODOMETER (MI)</div>
              <input type="number" value={form.odometer} onChange={e=>setForm(p=>({...p,odometer:e.target.value}))} style={{width:"100%"}} placeholder="0"/>
            </div>
            <div style={{gridColumn:"span 2"}}>
              <div style={{fontSize:11,color:"var(--gray)",marginBottom:4,fontFamily:"var(--mono)"}}>LOCATION</div>
              <input value={form.location} onChange={e=>setForm(p=>({...p,location:e.target.value}))} style={{width:"100%"}} placeholder="e.g. Loves Travel Stop, Phoenix AZ"/>
            </div>
            <div>
              <div style={{fontSize:11,color:"var(--gray)",marginBottom:4,fontFamily:"var(--mono)"}}>NOTES</div>
              <input value={form.notes} onChange={e=>setForm(p=>({...p,notes:e.target.value}))} style={{width:"100%"}} placeholder="Optional..."/>
            </div>
          </div>
          <div style={{display:"flex",gap:10,marginTop:14}}>
            <button type="submit" className="btn btn-green">Save Record</button>
            <button type="button" className="btn btn-ghost" onClick={()=>setShowAdd(false)}>Cancel</button>
          </div>
        </form>
      )}

      {/* Records Table */}
      <div style={{background:"var(--bg2)",border:"1px solid var(--border)",borderRadius:12,overflow:"hidden"}}>
        <table style={{width:"100%",borderCollapse:"collapse"}}>
          <thead>
            <tr style={{borderBottom:"1px solid var(--border)"}}>
              {["Truck","Driver","Date","Gallons","Price/Gal","Total Cost","Location","Odometer","Notes"].map(h=>(
                <th key={h} style={{padding:"12px 16px",textAlign:"left",fontSize:10,fontFamily:"var(--mono)",color:"var(--gray)",letterSpacing:1,textTransform:"uppercase"}}>{h}</th>
              ))}
            </tr>
          </thead>
          <tbody>
            {records.map(r=>(
              <tr key={r.id} style={{borderBottom:"1px solid var(--border)"}}
                onMouseEnter={e=>e.currentTarget.style.background="var(--bg3)"}
                onMouseLeave={e=>e.currentTarget.style.background="transparent"}>
                <td style={{padding:"12px 16px",fontFamily:"var(--mono)",fontSize:13,fontWeight:700,color:"var(--green)"}}>{r.truck_number}</td>
                <td style={{padding:"12px 16px",fontSize:12,color:"var(--gray)"}}>{r.username||"â€”"}</td>
                <td style={{padding:"12px 16px",fontFamily:"var(--mono)",fontSize:12,color:"var(--gray)"}}>{r.date}</td>
                <td style={{padding:"12px 16px",fontFamily:"var(--mono)",fontSize:12}}>{r.gallons} gal</td>
                <td style={{padding:"12px 16px",fontFamily:"var(--mono)",fontSize:12}}>${r.price_per_gallon}</td>
                <td style={{padding:"12px 16px",fontFamily:"var(--mono)",fontSize:13,fontWeight:700,color:"var(--yellow)"}}>${r.total_cost}</td>
                <td style={{padding:"12px 16px",fontSize:12,color:"var(--gray)"}}>{r.location||"â€”"}</td>
                <td style={{padding:"12px 16px",fontFamily:"var(--mono)",fontSize:12}}>{r.odometer?r.odometer.toLocaleString()+" mi":"â€”"}</td>
                <td style={{padding:"12px 16px",fontSize:12,color:"var(--gray)"}}>{r.notes||"â€”"}</td>
              </tr>
            ))}
          </tbody>
        </table>
        {records.length===0&&<div style={{textAlign:"center",padding:"40px",color:"var(--gray)",fontSize:13}}>No fuel records yet. Click + Add Fuel Record to get started.</div>}
      </div>
    </div>
  );
}

// â”€â”€ INSURANCE VIEW â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function InsuranceView() {
  const [policies, setPolicies] = useState([]);
  const [summary, setSummary] = useState({total:0,expired:0,expiring_soon:0,compliant:0,total_premium:0});
  const [showAdd, setShowAdd] = useState(false);
  const [toast, setToast] = useState(null);
  const [form, setForm] = useState({truck_number:"",policy_number:"",provider:"",policy_type:"Liability",premium:"",expiry_date:"",coverage_amount:"",notes:""});

  useEffect(()=>{ loadData(); },[]);

  async function loadData() {
    const [p, s] = await Promise.all([apiFetch("/insurance"), apiFetch("/insurance/summary")]);
    if(p) setPolicies(p);
    if(s) setSummary(s);
  }

  async function savePolicy(e) {
    e.preventDefault();
    await apiFetch("/insurance", {method:"POST", body:JSON.stringify({
      ...form, premium:+form.premium, coverage_amount:+form.coverage_amount
    })});
    await loadData();
    setShowAdd(false);
    setToast("âœ… Insurance policy added");
    setTimeout(()=>setToast(null), 3000);
    setForm({truck_number:"",policy_number:"",provider:"",policy_type:"Liability",premium:"",expiry_date:"",coverage_amount:"",notes:""});
  }

  function StatusBadge({status}) {
    const map = {ok:["tag-green","âœ“ ACTIVE"], expiring_soon:["tag-yellow","âš  EXPIRING"], expired:["tag-red","âœ— EXPIRED"], missing:["tag-gray","â€” MISSING"]};
    const [cls, label] = map[status]||["tag-gray","UNKNOWN"];
    return <span className={`tag ${cls}`}>{label}</span>;
  }

  return (
    <div style={{flex:1,overflowY:"auto",padding:24}}>
      {toast && <div style={{background:"var(--green)",color:"var(--black)",padding:"10px 20px",fontFamily:"var(--mono)",fontSize:12,fontWeight:600,textAlign:"center",marginBottom:16,borderRadius:8}}>{toast}</div>}
      <div style={{display:"flex",alignItems:"center",justifyContent:"space-between",marginBottom:20}}>
        <div>
          <div style={{fontFamily:"var(--mono)",fontSize:11,color:"var(--green)",letterSpacing:2,textTransform:"uppercase",marginBottom:6}}>Fleet Insurance</div>
          <div style={{fontFamily:"var(--display)",fontSize:22,fontWeight:800,letterSpacing:-0.8}}>Insurance Tracker</div>
        </div>
        <button className="btn btn-green" onClick={()=>setShowAdd(!showAdd)}>+ Add Policy</button>
      </div>

      {/* Summary Cards */}
      <div style={{display:"grid",gridTemplateColumns:"repeat(4,1fr)",gap:14,marginBottom:24}}>
        <KpiCard label="Total Policies" value={summary.total} sub="All trucks"/>
        <KpiCard label="Active" value={summary.compliant} sub="Fully covered" color="var(--green)"/>
        <KpiCard label="Expiring Soon" value={summary.expiring_soon} sub="Within 30 days" color="var(--yellow)"/>
        <KpiCard label="Annual Premiums" value={`$${summary.total_premium?.toLocaleString()}`} sub="Total cost" color="var(--blue)"/>
      </div>

      {/* Add Form */}
      {showAdd && (
        <form onSubmit={savePolicy} style={{background:"var(--bg2)",border:"1px solid var(--border)",borderRadius:12,padding:20,marginBottom:20}}>
          <div style={{fontFamily:"var(--display)",fontSize:15,fontWeight:700,marginBottom:16}}>New Insurance Policy</div>
          <div style={{display:"grid",gridTemplateColumns:"repeat(3,1fr)",gap:12}}>
            {[["truck_number","Truck Number"],["policy_number","Policy Number"],["provider","Insurance Provider"],["premium","Annual Premium ($)"],["coverage_amount","Coverage Amount ($)"]].map(([k,lbl])=>(
              <div key={k}>
                <div style={{fontSize:11,color:"var(--gray)",marginBottom:4,fontFamily:"var(--mono)"}}>{lbl.toUpperCase()}</div>
                <input type={["premium","coverage_amount"].includes(k)?"number":"text"} value={form[k]} onChange={e=>setForm(p=>({...p,[k]:e.target.value}))} style={{width:"100%"}} required={["truck_number","policy_number","provider","premium"].includes(k)}/>
              </div>
            ))}
            <div>
              <div style={{fontSize:11,color:"var(--gray)",marginBottom:4,fontFamily:"var(--mono)"}}>POLICY TYPE</div>
              <select value={form.policy_type} onChange={e=>setForm(p=>({...p,policy_type:e.target.value}))} style={{width:"100%"}}>
                <option>Liability</option>
                <option>Cargo</option>
                <option>Physical Damage</option>
                <option>Bobtail</option>
                <option>General Liability</option>
              </select>
            </div>
            <div>
              <div style={{fontSize:11,color:"var(--gray)",marginBottom:4,fontFamily:"var(--mono)"}}>EXPIRY DATE</div>
              <input type="date" value={form.expiry_date} onChange={e=>setForm(p=>({...p,expiry_date:e.target.value}))} style={{width:"100%"}} required/>
            </div>
            <div>
              <div style={{fontSize:11,color:"var(--gray)",marginBottom:4,fontFamily:"var(--mono)"}}>NOTES</div>
              <input value={form.notes} onChange={e=>setForm(p=>({...p,notes:e.target.value}))} style={{width:"100%"}} placeholder="Optional..."/>
            </div>
          </div>
          <div style={{display:"flex",gap:10,marginTop:14}}>
            <button type="submit" className="btn btn-green">Save Policy</button>
            <button type="button" className="btn btn-ghost" onClick={()=>setShowAdd(false)}>Cancel</button>
          </div>
        </form>
      )}

      {/* Policies Table */}
      <div style={{background:"var(--bg2)",border:"1px solid var(--border)",borderRadius:12,overflow:"hidden"}}>
        <table style={{width:"100%",borderCollapse:"collapse"}}>
          <thead>
            <tr style={{borderBottom:"1px solid var(--border)"}}>
              {["Truck","Policy #","Provider","Type","Premium","Coverage","Expiry","Status"].map(h=>(
                <th key={h} style={{padding:"12px 16px",textAlign:"left",fontSize:10,fontFamily:"var(--mono)",color:"var(--gray)",letterSpacing:1,textTransform:"uppercase"}}>{h}</th>
              ))}
            </tr>
          </thead>
          <tbody>
            {policies.map(p=>(
              <tr key={p.id} style={{borderBottom:"1px solid var(--border)"}}
                onMouseEnter={e=>e.currentTarget.style.background="var(--bg3)"}
                onMouseLeave={e=>e.currentTarget.style.background="transparent"}>
                <td style={{padding:"12px 16px",fontWeight:600,fontSize:13}}>{p.truck_number}</td>
                <td style={{padding:"12px 16px",fontFamily:"var(--mono)",fontSize:11,color:"var(--gray)"}}>{p.policy_number}</td>
                <td style={{padding:"12px 16px",fontSize:13}}>{p.provider}</td>
                <td style={{padding:"12px 16px"}}><span className="tag tag-blue">{p.policy_type}</span></td>
                <td style={{padding:"12px 16px",fontFamily:"var(--mono)",fontSize:13,color:"var(--white)"}}>${p.premium?.toLocaleString()}</td>
                <td style={{padding:"12px 16px",fontFamily:"var(--mono)",fontSize:12,color:"var(--gray)"}}>${p.coverage_amount?.toLocaleString()}</td>
                <td style={{padding:"12px 16px",fontFamily:"var(--mono)",fontSize:12,color:"var(--gray)"}}>{p.expiry_date}</td>
                <td style={{padding:"12px 16px"}}><StatusBadge status={p.status}/></td>
              </tr>
            ))}
          </tbody>
        </table>
        {policies.length===0&&<div style={{textAlign:"center",padding:"40px",color:"var(--gray)",fontSize:13}}>No policies yet. Click + Add Policy to get started.</div>}
      </div>
    </div>
  );
}

// â”€â”€ INSPECTION VIEW â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const CHECKLIST_ITEMS = [
  {id:"front_bumper",label:"Front Bumper",icon:"ğŸš—"},
  {id:"rear_bumper",label:"Rear Bumper",icon:"ğŸš—"},
  {id:"left_side",label:"Left Side Panel",icon:"ğŸ”²"},
  {id:"right_side",label:"Right Side Panel",icon:"ğŸ”²"},
  {id:"windshield",label:"Windshield",icon:"ğŸªŸ"},
  {id:"headlights",label:"Headlights",icon:"ğŸ’¡"},
  {id:"tail_lights",label:"Tail Lights",icon:"ğŸ”´"},
  {id:"mirrors",label:"Side Mirrors",icon:"ğŸ”"},
  {id:"tires",label:"Tires & Wheels",icon:"âš™ï¸"},
  {id:"fuel_level",label:"Fuel Level",icon:"â›½"},
  {id:"interior",label:"Interior Condition",icon:"ğŸª‘"},
  {id:"brakes",label:"Brakes",icon:"ğŸ›‘"},
];

const VEHICLES = [
  {id:"TRK-001",name:"Truck 001",type:"Cargo Truck",plate:"XA-2341"},
  {id:"VAN-012",name:"Van 012",type:"Delivery Van",plate:"GH-8812"},
  {id:"BUS-003",name:"Bus 003",type:"Passenger Bus",plate:"KL-5590"},
  {id:"TRK-007",name:"Truck 007",type:"Flatbed Truck",plate:"MN-1127"},
];

function InspectionView({drivers}) {
  const [step, setStep] = useState(1);
  const [driver, setDriver] = useState(null);
  const [vehicle, setVehicle] = useState(null);
  const [checklistState, setChecklistState] = useState({});
  const [notes, setNotes] = useState({});
  const [photos, setPhotos] = useState({});
  const [cameraItem, setCameraItem] = useState(null);
  const [stream, setStream] = useState(null);
  const videoRef = React.useRef(null);
  const canvasRef = React.useRef(null);
  const [inspections, setInspections] = useState([]);
  const [alerts, setAlerts] = useState([]);
  const [subview, setSubview] = useState("dashboard");
  const [submitting, setSubmitting] = useState(false);
  const [gpsLocation, setGpsLocation] = useState(null);
  const [gpsAccuracy, setGpsAccuracy] = useState(null);
  const currentTime = new Date().toLocaleString("en-US",{month:"short",day:"2-digit",year:"numeric",hour:"2-digit",minute:"2-digit"});

  useEffect(()=>{
    async function loadInspections() {
      const data = await apiFetch(`/inspections?company_id=${fqUser?.company_id||1}`);
      if(data && Array.isArray(data)) {
        setInspections(data.map(r=>({
          id: `INS-${r.id}`,
          driver: r.driver_name,
          vehicle: r.vehicle,
          timestamp: new Date(r.submitted_at).toLocaleString(),
          status: r.status,
          issues: r.damage_items ? r.damage_items.split(", ") : [],
          gps_location: r.gps_location
        })));
      }
    }
    loadInspections();
  },[]);

  function toggleCheck(id, val) { setChecklistState(prev=>({...prev,[id]:val})); }
  function getProgress() { return Math.round((Object.keys(checklistState).length/CHECKLIST_ITEMS.length)*100); }
  function getDamageItems() { return CHECKLIST_ITEMS.filter(i=>checklistState[i.id]==="damaged"); }

  async function submitInspection() {
    setSubmitting(true);
    // Get GPS location
    let gpsLoc = "Location unavailable";
    if(navigator.geolocation) {
      gpsLoc = await new Promise((resolve)=>{
        navigator.geolocation.getCurrentPosition(
          (pos) => {
            const loc = `${pos.coords.latitude.toFixed(5)}Â°N, ${pos.coords.longitude.toFixed(5)}Â°W`;
            setGpsLocation(loc);
            setGpsAccuracy(Math.round(pos.coords.accuracy));
            resolve(loc);
          },
          () => { setGpsLocation("Location unavailable"); resolve("Location unavailable"); },
          {timeout:5000}
        );
      });
    }
    const damageItems = getDamageItems();
    const status = damageItems.length > 0 ? "issues" : "clear";
    // Save to database
    try {
      const res = await apiFetch("/inspections", {
        method: "POST",
        body: JSON.stringify({
          company_id: fqUser?.company_id || 1,
          driver_name: driver?.full_name || driver?.username,
          vehicle: `${vehicle.id} â€” ${vehicle.plate}`,
          status: status,
          damage_items: damageItems.map(i=>i.label).join(", ") || null,
          gps_location: gpsLoc,
          notes: Object.values(notes).filter(Boolean).join("; ") || null
        })
      });
      const ins = {
        id: res?.id ? `INS-${res.id}` : `INS-${Date.now()}`,
        driver: driver?.full_name || driver?.username,
        vehicle: vehicle.id,
        plate: vehicle.plate,
        timestamp: currentTime,
        status: status,
        issues: damageItems.map(i=>i.label),
      };
      setInspections(prev=>[ins,...prev]);
      if(damageItems.length > 0) {
        setAlerts(prev=>[{id:Date.now(),type:"damage",message:`${vehicle.id} â€” Damage: ${damageItems.map(i=>i.label).join(", ")} by ${driver?.full_name||driver?.username}`,time:"Just now",read:false},...prev]);
        // Send damage alert email
        apiFetch("/inspection/damage-alert", {
          method: "POST",
          body: JSON.stringify({
            company_id: fqUser?.company_id || 1,
            driver_name: driver?.full_name || driver?.username,
            vehicle: `${vehicle.id} â€” ${vehicle.plate}`,
            issues: damageItems.map(i=>i.label)
          })
        });
      }
    } catch(e) {
      console.error("Inspection save error:", e);
    }
    setSubmitting(false);
    setStep(4);
  }
   function resetForm() { setDriver(null);setVehicle(null);setChecklistState({});setNotes({});setPhotos({});setStep(1);setSubview("dashboard");closeCamera(); }

  async function openCamera(itemId) {
    setCameraItem(itemId);
    try {
      const s = await navigator.mediaDevices.getUserMedia({video:{facingMode:"environment"},audio:false});
      setStream(s);
      setTimeout(()=>{ if(videoRef.current) videoRef.current.srcObject=s; },100);
    } catch(e) {
      alert("Camera not available. Please allow camera access.");
      setCameraItem(null);
    }
  }

  function closeCamera() {
    if(stream) { stream.getTracks().forEach(t=>t.stop()); setStream(null); }
    setCameraItem(null);
  }

  function capturePhoto() {
    if(!videoRef.current||!canvasRef.current) return;
    const canvas = canvasRef.current;
    canvas.width = videoRef.current.videoWidth;
    canvas.height = videoRef.current.videoHeight;
    canvas.getContext("2d").drawImage(videoRef.current,0,0);
    const dataUrl = canvas.toDataURL("image/jpeg",0.8);
    setPhotos(p=>({...p,[cameraItem]:dataUrl}));
    closeCamera();
  }

  const unread = alerts.filter(a=>!a.read).length;

  return (
    <div style={{flex:1,overflowY:"auto",padding:24,background:"var(--bg)"}}>
      <div style={{display:"flex",alignItems:"center",justifyContent:"space-between",marginBottom:20}}>
        <div>
          <div style={{fontFamily:"var(--mono)",fontSize:11,color:"var(--green)",letterSpacing:2,textTransform:"uppercase",marginBottom:6}}>Fleet Management</div>
          <div style={{fontFamily:"var(--display)",fontSize:22,fontWeight:800,letterSpacing:-0.8}}>Vehicle Inspection</div>
        </div>
        <div style={{display:"flex",gap:8}}>
          {["dashboard","inspect","history","alerts"].map(v=>(
            <button key={v} className="btn btn-ghost btn-sm" onClick={()=>{setSubview(v);if(v==="inspect")setStep(1);}}
              style={{background:subview===v?"var(--green-glow)":"transparent",color:subview===v?"var(--green)":"var(--gray)",borderColor:subview===v?"rgba(255,107,53,0.3)":"var(--border)",position:"relative"}}>
              {v==="alerts"&&unread>0&&<span style={{position:"absolute",top:-6,right:-6,background:"var(--red)",color:"#fff",borderRadius:"50%",width:14,height:14,fontSize:8,display:"flex",alignItems:"center",justifyContent:"center",fontWeight:700}}>{unread}</span>}
              {v.charAt(0).toUpperCase()+v.slice(1)}
            </button>
          ))}
        </div>
      </div>
       
            {/* CAMERA MODAL */}
      {cameraItem&&(
        <div style={{position:"fixed",top:0,left:0,right:0,bottom:0,background:"rgba(0,0,0,0.95)",zIndex:1000,display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",gap:16}}>
          <div style={{fontFamily:"var(--mono)",fontSize:11,color:"var(--green)",letterSpacing:2,textTransform:"uppercase"}}>Camera â€” {CHECKLIST_ITEMS.find(i=>i.id===cameraItem)?.label}</div>
          <video ref={videoRef} autoPlay playsInline style={{width:"100%",maxWidth:480,borderRadius:12,border:"2px solid var(--green)"}}/>
          <canvas ref={canvasRef} style={{display:"none"}}/>
          <div style={{display:"flex",gap:12}}>
            <button className="btn btn-green" onClick={capturePhoto} style={{padding:"12px 32px",fontSize:14}}>ğŸ“· Capture</button>
            <button className="btn btn-ghost" onClick={closeCamera}>Cancel</button>
          </div>
        </div>
      )}
      {/* DASHBOARD */}
      {subview==="dashboard"&&(
        <div>
          <div style={{display:"grid",gridTemplateColumns:"repeat(4,1fr)",gap:14,marginBottom:24}}>
            <KpiCard label="Inspections Today" value={inspections.length} sub="Submitted"/>
            <KpiCard label="Issues Reported" value={inspections.filter(i=>i.status==="issues").length} sub="Vehicles with damage" color="var(--yellow)"/>
            <KpiCard label="Clear" value={inspections.filter(i=>i.status==="clear").length} sub="No issues" color="var(--green)"/>
            <KpiCard label="Alerts" value={unread} sub="Unread" color="var(--red)"/>
          </div>
          <button className="btn btn-green" onClick={()=>{setSubview("inspect");setStep(1);}}>+ New Inspection</button>
          <div style={{background:"var(--bg2)",border:"1px solid var(--border)",borderRadius:12,overflow:"hidden",marginTop:20}}>
            <table style={{width:"100%",borderCollapse:"collapse"}}>
              <thead><tr style={{borderBottom:"1px solid var(--border)"}}>
                {["ID","Driver","Vehicle","Time","Status"].map(h=><th key={h} style={{padding:"12px 16px",textAlign:"left",fontSize:10,fontFamily:"var(--mono)",color:"var(--gray)",letterSpacing:1,textTransform:"uppercase"}}>{h}</th>)}
              </tr></thead>
              <tbody>
                {inspections.map(ins=>(
                  <tr key={ins.id} style={{borderBottom:"1px solid var(--border)"}}
                    onMouseEnter={e=>e.currentTarget.style.background="var(--bg3)"}
                    onMouseLeave={e=>e.currentTarget.style.background="transparent"}>
                    <td style={{padding:"12px 16px",fontFamily:"var(--mono)",fontSize:11,color:"var(--green)"}}>{ins.id}</td>
                    <td style={{padding:"12px 16px",fontSize:13}}>{ins.driver}</td>
                    <td style={{padding:"12px 16px",fontSize:13}}>{ins.vehicle} Â· {ins.plate}</td>
                    <td style={{padding:"12px 16px",fontSize:12,color:"var(--gray)",fontFamily:"var(--mono)"}}>{ins.timestamp}</td>
                    <td style={{padding:"12px 16px"}}><span className={`tag ${ins.status==="clear"?"tag-green":"tag-red"}`}>{ins.status==="clear"?"âœ“ CLEAR":"âš  ISSUES"}</span></td>
                  </tr>
                ))}
              </tbody>
            </table>
            {inspections.length===0&&<div style={{textAlign:"center",padding:"40px",color:"var(--gray)",fontSize:13}}>No inspections yet. Click + New Inspection to start.</div>}
          </div>
        </div>
      )}

      {/* INSPECT */}
      {subview==="inspect"&&(
        <div>
          {/* Steps */}
          <div style={{display:"flex",alignItems:"center",gap:0,marginBottom:24}}>
            {["Select","Checklist","Confirm","Done"].map((s,i)=>(
              <div key={i} style={{display:"flex",alignItems:"center",flex:i<3?1:0}}>
                <div style={{width:28,height:28,borderRadius:"50%",background:step>i+1?"var(--green)":step===i+1?"rgba(255,107,53,0.2)":"var(--bg3)",border:`2px solid ${step>=i+1?"var(--green)":"var(--border)"}`,display:"flex",alignItems:"center",justifyContent:"center",fontSize:11,color:step>i+1?"#000":step===i+1?"var(--green)":"var(--gray)",fontWeight:700}}>
                  {step>i+1?"âœ“":i+1}
                </div>
                {i<3&&<div style={{flex:1,height:2,background:step>i+1?"var(--green)":"var(--border)"}}></div>}
              </div>
            ))}
          </div>

          {/* Step 1 */}
          {step===1&&(
            <div>
              <div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:20,marginBottom:20}}>
                <div>
                  <div style={{fontSize:11,fontFamily:"var(--mono)",color:"var(--green)",letterSpacing:1,textTransform:"uppercase",marginBottom:12}}>Select Driver</div>
                  {drivers.map(d=>(
                    <div key={d.id} onClick={()=>setDriver(d)} style={{padding:"12px 16px",marginBottom:8,borderRadius:10,cursor:"pointer",background:driver?.id===d.id?"var(--green-glow)":"var(--bg2)",border:`1px solid ${driver?.id===d.id?"rgba(255,107,53,0.4)":"var(--border)"}`,display:"flex",alignItems:"center",gap:12}}>
                      <div style={{width:36,height:36,borderRadius:"50%",background:"var(--bg3)",display:"flex",alignItems:"center",justifyContent:"center",fontFamily:"var(--mono)",fontSize:11,color:"var(--gray)"}}>{d.username?.slice(0,2)}</div>
                      <div>
                        <div style={{fontWeight:600,fontSize:13}}>{d.full_name}</div>
                        <div style={{fontSize:11,color:"var(--gray)",fontFamily:"var(--mono)"}}>{d.driver_type}</div>
                      </div>
                      {driver?.id===d.id&&<span style={{marginLeft:"auto",color:"var(--green)"}}>âœ“</span>}
                    </div>
                  ))}
                </div>
                <div>
                  <div style={{fontSize:11,fontFamily:"var(--mono)",color:"var(--green)",letterSpacing:1,textTransform:"uppercase",marginBottom:12}}>Select Vehicle</div>
                  {VEHICLES.map(v=>(
                    <div key={v.id} onClick={()=>setVehicle(v)} style={{padding:"12px 16px",marginBottom:8,borderRadius:10,cursor:"pointer",background:vehicle?.id===v.id?"var(--green-glow)":"var(--bg2)",border:`1px solid ${vehicle?.id===v.id?"rgba(255,107,53,0.4)":"var(--border)"}`}}>
                      <div style={{display:"flex",justifyContent:"space-between"}}>
                        <div style={{fontWeight:600,fontSize:13}}>{v.name}</div>
                        {vehicle?.id===v.id&&<span style={{color:"var(--green)"}}>âœ“</span>}
                      </div>
                      <div style={{fontSize:11,color:"var(--gray)",fontFamily:"var(--mono)",marginTop:4}}>{v.type} Â· {v.plate}</div>
                    </div>
                  ))}
                </div>
              </div>
              <button className="btn btn-green" onClick={()=>driver&&vehicle&&setStep(2)} style={{opacity:driver&&vehicle?1:0.4,width:"100%",marginTop:16,padding:"14px 0",fontSize:16}}>Start Inspection â†’</button>
              <div style={{height:80}}/>
            </div>
          )}

          {/* Step 2 */}
          {step===2&&(
            <div>
              <div style={{display:"flex",justifyContent:"space-between",marginBottom:8}}>
                <span style={{fontSize:12,color:"var(--gray)",fontFamily:"var(--mono)"}}>{getProgress()}% Complete</span>
                <span style={{fontSize:12,color:"var(--gray)",fontFamily:"var(--mono)"}}>{Object.keys(checklistState).length}/{CHECKLIST_ITEMS.length} items</span>
              </div>
              <div style={{height:4,background:"var(--bg3)",borderRadius:2,marginBottom:20,overflow:"hidden"}}>
                <div style={{height:"100%",width:`${getProgress()}%`,background:"var(--green)",borderRadius:2,transition:"width 0.3s"}}></div>
              </div>
              {CHECKLIST_ITEMS.map(item=>(
                <div key={item.id} style={{padding:"14px 16px",marginBottom:8,borderRadius:10,background:checklistState[item.id]==="ok"?"rgba(0,100,0,0.1)":checklistState[item.id]==="damaged"?"rgba(100,0,0,0.1)":"var(--bg2)",border:`1px solid ${checklistState[item.id]==="ok"?"rgba(0,200,0,0.2)":checklistState[item.id]==="damaged"?"rgba(200,0,0,0.2)":"var(--border)"}`}}>
                  <div style={{display:"flex",alignItems:"center",justifyContent:"space-between",gap:12,flexWrap:"wrap"}}>
                    <div style={{display:"flex",alignItems:"center",gap:10}}>
                      <span style={{fontSize:18}}>{item.icon}</span>
                      <span style={{fontSize:13,fontWeight:500}}>{item.label}</span>
                    </div>
                    <div style={{display:"flex",gap:8}}>
                      <button className="btn btn-sm" onClick={()=>toggleCheck(item.id,"ok")} style={{background:checklistState[item.id]==="ok"?"rgba(0,200,0,0.2)":"transparent",color:checklistState[item.id]==="ok"?"#4ADE80":"var(--gray)",border:`1px solid ${checklistState[item.id]==="ok"?"#16a34a":"var(--border)"}`}}>âœ“ OK</button>
                      <button className="btn btn-sm" onClick={()=>toggleCheck(item.id,"damaged")} style={{background:checklistState[item.id]==="damaged"?"rgba(200,0,0,0.2)":"transparent",color:checklistState[item.id]==="damaged"?"var(--red)":"var(--gray)",border:`1px solid ${checklistState[item.id]==="damaged"?"var(--red)":"var(--border)"}`}}>âœ— DAMAGED</button>
                      <button className="btn btn-sm" onClick={()=>openCamera(item.id)} style={{background:photos[item.id]?"rgba(255,107,53,0.1)":"transparent",color:photos[item.id]?"var(--green)":"var(--gray)",border:`1px solid ${photos[item.id]?"var(--green)":"var(--border)"}`}}>{photos[item.id]?"ğŸ“· 1 Photo":"ğŸ“· Add Photo"}</button>
                    </div>
                  </div>
                  {checklistState[item.id]==="damaged"&&(
                    <textarea value={notes[item.id]||""} onChange={e=>setNotes(p=>({...p,[item.id]:e.target.value}))} placeholder="Describe the damage..." style={{width:"100%",marginTop:10,background:"var(--bg3)",border:"1px solid var(--border)",color:"var(--white)",padding:"8px 12px",borderRadius:8,fontFamily:"var(--body)",fontSize:12,resize:"vertical",minHeight:60}}/>
                  )}
                </div>
              ))}
              <div style={{display:"flex",gap:10,marginTop:16}}>
                <button className="btn btn-ghost" onClick={()=>setStep(1)}>â† Back</button>
                <button className="btn btn-green" onClick={()=>getProgress()===100&&setStep(3)} style={{opacity:getProgress()===100?1:0.4}}>Review & Submit â†’</button>
              </div>
              <div style={{height:80}}/>
            </div>
          )}

          {/* Step 3 */}
          {step===3&&(
            <div style={{background:"var(--bg2)",border:"1px solid var(--border)",borderRadius:12,padding:20}}>
              <div style={{fontFamily:"var(--display)",fontSize:16,fontWeight:700,marginBottom:16}}>Inspection Summary</div>
              <div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:16,marginBottom:16}}>
                <div><div style={{fontSize:11,color:"var(--gray)",fontFamily:"var(--mono)",marginBottom:4}}>DRIVER</div><div style={{fontWeight:600}}>{driver?.full_name}</div></div>
                <div><div style={{fontSize:11,color:"var(--gray)",fontFamily:"var(--mono)",marginBottom:4}}>VEHICLE</div><div style={{fontWeight:600}}>{vehicle?.id} Â· {vehicle?.plate}</div></div>
                <div><div style={{fontSize:11,color:"var(--gray)",fontFamily:"var(--mono)",marginBottom:4}}>TIME</div><div style={{fontSize:12}}>{currentTime}</div></div>
                <div><div style={{fontSize:11,color:"var(--gray)",fontFamily:"var(--mono)",marginBottom:4}}>GPS LOCATION</div><div style={{fontSize:12,color:"#60A5FA"}}>{gpsLocation||"Acquiring location..."}</div></div>
                <div><div style={{fontSize:11,color:"var(--gray)",fontFamily:"var(--mono)",marginBottom:4}}>ITEMS CHECKED</div><div style={{fontWeight:600}}>{CHECKLIST_ITEMS.length}</div></div>
              </div>
              <div style={{display:"flex",gap:20,marginBottom:16}}>
                <div><div style={{fontSize:10,color:"var(--gray)",fontFamily:"var(--mono)"}}>OK</div><div style={{fontSize:24,fontWeight:800,color:"var(--green)"}}>{CHECKLIST_ITEMS.filter(i=>checklistState[i.id]==="ok").length}</div></div>
                <div><div style={{fontSize:10,color:"var(--gray)",fontFamily:"var(--mono)"}}>DAMAGED</div><div style={{fontSize:24,fontWeight:800,color:"var(--red)"}}>{getDamageItems().length}</div></div>
              </div>
              {getDamageItems().length>0&&(
                <div style={{background:"rgba(100,0,0,0.1)",border:"1px solid rgba(200,0,0,0.2)",borderRadius:8,padding:12,marginBottom:16}}>
                  <div style={{fontSize:11,color:"var(--red)",fontFamily:"var(--mono)",marginBottom:8}}>âš  DAMAGE REPORTED</div>
                  {getDamageItems().map(i=><div key={i.id} style={{fontSize:12,marginBottom:4}}>{i.icon} {i.label}{notes[i.id]&&` â€” ${notes[i.id]}`}</div>)}
                </div>
              )}
              <div style={{display:"flex",gap:10}}>
                <button className="btn btn-ghost" onClick={()=>setStep(2)}>â† Edit</button>
                <button className="btn btn-green" onClick={submitInspection} disabled={submitting}>{submitting?"Submitting...":"âœ“ Submit Inspection"}</button>
              </div>
            </div>
          )}

          {/* Step 4 */}
          {step===4&&(
            <div style={{textAlign:"center",paddingTop:40}}>
              <div style={{width:72,height:72,borderRadius:"50%",background:"rgba(0,100,0,0.2)",border:"2px solid #16a34a",display:"flex",alignItems:"center",justifyContent:"center",fontSize:32,margin:"0 auto 24px"}}>âœ“</div>
              <div style={{fontFamily:"var(--display)",fontSize:22,fontWeight:800,marginBottom:10}}>Inspection Submitted!</div>
              <div style={{fontSize:13,color:"var(--gray)",marginBottom:10}}>{getDamageItems().length>0?"âš  Damage reported â€” Management has been alerted":"âœ“ Vehicle cleared â€” No issues detected"}</div>
              {gpsLocation&&(
                <div style={{display:"inline-flex",alignItems:"center",gap:6,padding:"6px 14px",background:"rgba(0,100,200,0.1)",border:"1px solid rgba(0,100,200,0.3)",borderRadius:6,fontSize:11,color:"#60A5FA",fontFamily:"var(--mono)",marginBottom:16}}>
                  ğŸ“ {gpsLocation} {gpsAccuracy&&`Â· Â±${gpsAccuracy}m accuracy`}
                </div>
              )}
              <div style={{display:"flex",gap:10,justifyContent:"center"}}>
                <button className="btn btn-green" onClick={resetForm}>+ New Inspection</button>
                <button className="btn btn-ghost" onClick={()=>{resetForm();setSubview("history");}}>View History</button>
              </div>
            </div>
          )}
        </div>
      )}

      {/* HISTORY */}
      {subview==="history"&&(
        <div style={{background:"var(--bg2)",border:"1px solid var(--border)",borderRadius:12,overflow:"hidden"}}>
          <table style={{width:"100%",borderCollapse:"collapse"}}>
            <thead><tr style={{borderBottom:"1px solid var(--border)"}}>
              {["ID","Driver","Vehicle","Time","Status","Issues"].map(h=><th key={h} style={{padding:"12px 16px",textAlign:"left",fontSize:10,fontFamily:"var(--mono)",color:"var(--gray)",letterSpacing:1,textTransform:"uppercase"}}>{h}</th>)}
            </tr></thead>
            <tbody>
              {inspections.map(ins=>(
                <tr key={ins.id} style={{borderBottom:"1px solid var(--border)"}}
                  onMouseEnter={e=>e.currentTarget.style.background="var(--bg3)"}
                  onMouseLeave={e=>e.currentTarget.style.background="transparent"}>
                  <td style={{padding:"12px 16px",fontFamily:"var(--mono)",fontSize:11,color:"var(--green)"}}>{ins.id}</td>
                  <td style={{padding:"12px 16px",fontSize:13}}>{ins.driver}</td>
                  <td style={{padding:"12px 16px",fontSize:13}}>{ins.vehicle} Â· {ins.plate}</td>
                  <td style={{padding:"12px 16px",fontSize:12,color:"var(--gray)",fontFamily:"var(--mono)"}}>{ins.timestamp}</td>
                  <td style={{padding:"12px 16px"}}><span className={`tag ${ins.status==="clear"?"tag-green":"tag-red"}`}>{ins.status==="clear"?"âœ“ CLEAR":"âš  ISSUES"}</span></td>
                  <td style={{padding:"12px 16px",fontSize:11,color:"var(--gray)"}}>{ins.issues.join(", ")||"â€”"}</td>
                </tr>
              ))}
            </tbody>
          </table>
          {inspections.length===0&&<div style={{textAlign:"center",padding:"40px",color:"var(--gray)",fontSize:13}}>No inspections yet.</div>}
        </div>
      )}

      {/* ALERTS */}
      {subview==="alerts"&&(
        <div style={{background:"var(--bg2)",border:"1px solid var(--border)",borderRadius:12,overflow:"hidden"}}>
          {alerts.map(a=>(
            <div key={a.id} style={{padding:"16px",borderBottom:"1px solid var(--border)",display:"flex",alignItems:"flex-start",gap:12,background:a.type==="damage"?"rgba(100,0,0,0.05)":"transparent",opacity:a.read?0.5:1}}>
              <div style={{width:10,height:10,borderRadius:"50%",background:a.type==="damage"?"var(--red)":"var(--yellow)",flexShrink:0,marginTop:4}}></div>
              <div style={{flex:1}}>
                <div style={{fontSize:12,marginBottom:4}}>{a.message}</div>
                <div style={{fontSize:10,color:"var(--gray)",fontFamily:"var(--mono)"}}>{a.time}</div>
              </div>
              {!a.read&&<button className="btn btn-ghost btn-sm" onClick={()=>setAlerts(prev=>prev.map(x=>x.id===a.id?{...x,read:true}:x))}>Mark read</button>}
            </div>
          ))}
          {alerts.length===0&&<div style={{textAlign:"center",padding:"40px",color:"var(--gray)",fontSize:13}}>No alerts.</div>}
        </div>
      )}
    </div>
  );
}

// â”€â”€ FUEL & IFTA VIEW â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const US_STATES = ["AL","AK","AZ","AR","CA","CO","CT","DE","FL","GA","ID","IL","IN","IA","KS","KY","LA","ME","MD","MA","MI","MN","MS","MO","MT","NE","NV","NH","NJ","NM","NY","NC","ND","OH","OK","OR","PA","RI","SC","SD","TN","TX","UT","VT","VA","WA","WV","WI","WY"];

function FuelIFTAView({drivers}) {
  const [tab, setTab] = useState("dashboard");
  const [fuelLog, setFuelLog] = useState([]);
  const [analytics, setAnalytics] = useState(null);
  const [ifta, setIfta] = useState(null);
  const [loading, setLoading] = useState(true);
  const [iftaLoading, setIftaLoading] = useState(false);
  const [showAdd, setShowAdd] = useState(false);
  const [showMiles, setShowMiles] = useState(false);
  const [milesForm, setMilesForm] = useState({
    vehicle:"", driver_name:"", state:"TX", miles:"",
    trip_date: new Date().toISOString().slice(0,10), load_id:""
  });
  const [savingMiles, setSavingMiles] = useState(false);
  const [saving, setSaving] = useState(false);
  const [toast, setToast] = useState(null);
  const [quarter, setQuarter] = useState(1);
  const [year, setYear] = useState(2026);
  const [form, setForm] = useState({
    driver_name:"", vehicle:"", state:"TX", gallons:"", price_per_gallon:"",
    odometer:"", fuel_date:new Date().toISOString().slice(0,10),
    fuel_type:"diesel", vendor:"", notes:""
  });

  useEffect(()=>{ loadAll(); },[]);
  
  async function saveMiles(e) {
    e.preventDefault();
    setSavingMiles(true);
    const res = await apiFetch("/miles", {
      method:"POST",
      body: JSON.stringify({
        ...milesForm,
        company_id: fqUser?.company_id||1,
        miles: parseFloat(milesForm.miles),
        load_id: milesForm.load_id ? parseInt(milesForm.load_id) : null
      })
    });
    setSavingMiles(false);
    if(res?.message) {
      setToast("âœ… Miles logged!");
      setShowMiles(false);
      setMilesForm({vehicle:"",driver_name:"",state:"TX",miles:"",trip_date:new Date().toISOString().slice(0,10),load_id:""});
    } else {
      setToast("âŒ Error logging miles");
    }
    setTimeout(()=>setToast(null),3000);
  }

  async function loadAll() {
    setLoading(true);
    const [fuel, anal] = await Promise.all([
      apiFetch(`/fuel?company_id=${fqUser?.company_id||1}`),
      apiFetch(`/fuel/analytics?company_id=${fqUser?.company_id||1}`)
    ]);
    if(fuel) setFuelLog(fuel);
    if(anal) setAnalytics(anal);
    setLoading(false);
  }

  async function loadIFTA() {
    setIftaLoading(true);
    const data = await apiFetch(`/ifta/report?company_id=${fqUser?.company_id||1}&quarter=${quarter}&year=${year}`);
    if(data) setIfta(data);
    setIftaLoading(false);
  }

  async function saveFuel(e) {
    e.preventDefault();
    setSaving(true);
    const res = await apiFetch("/fuel", {
      method:"POST",
      body: JSON.stringify({...form, company_id: fqUser?.company_id||1,
        gallons: parseFloat(form.gallons), price_per_gallon: parseFloat(form.price_per_gallon),
        odometer: form.odometer ? parseInt(form.odometer) : null})
    });
    setSaving(false);
    if(res?.id) {
      setToast("âœ… Fuel entry saved!");
      setShowAdd(false);
      setForm({driver_name:"",vehicle:"",state:"TX",gallons:"",price_per_gallon:"",odometer:"",fuel_date:new Date().toISOString().slice(0,10),fuel_type:"diesel",vendor:"",notes:""});
      loadAll();
    } else {
      setToast("âŒ Error saving fuel entry");
    }
    setTimeout(()=>setToast(null),3000);
  }

  const totalSpend = analytics?.totals?.total_spend || 0;
  const totalGallons = analytics?.totals?.total_gallons || 0;
  const avgPPG = analytics?.totals?.avg_ppg || 0;

  if(loading) return <div style={{padding:40,color:"var(--gray)"}}>Loading...</div>;

  return (
    <div style={{flex:1,overflowY:"auto",padding:24}}>
      {toast&&<div style={{background:toast.includes("âœ…")?"rgba(0,200,0,0.1)":"rgba(200,0,0,0.1)",border:`1px solid ${toast.includes("âœ…")?"rgba(0,200,0,0.3)":"rgba(200,0,0,0.3)"}`,borderRadius:8,padding:"10px 16px",marginBottom:16,fontSize:13,color:toast.includes("âœ…")?"var(--green)":"var(--red)"}}>{toast}</div>}

      <div style={{display:"flex",alignItems:"center",justifyContent:"space-between",marginBottom:20}}>
        <div>
          <div style={{fontFamily:"var(--mono)",fontSize:11,color:"var(--green)",letterSpacing:2,textTransform:"uppercase",marginBottom:6}}>Fuel Management & Tax</div>
          <div style={{fontFamily:"var(--display)",fontSize:22,fontWeight:800,letterSpacing:-0.8}}>Fuel & IFTA</div>
        </div>
        <div style={{display:"flex",gap:8}}>
          <button className="btn btn-ghost" onClick={()=>setShowMiles(!showMiles)}>ğŸ›£ Log Miles</button>
          <button className="btn btn-green" onClick={()=>setShowAdd(!showAdd)}>+ Log Fuel</button>
        </div>
      </div>

      {/* KPI Cards */}
      <div style={{display:"grid",gridTemplateColumns:"repeat(4,1fr)",gap:12,marginBottom:20}}>
        {[
          {label:"Total Fuel Spend",value:`$${Number(totalSpend).toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2})}`,icon:"ğŸ’¸",color:"var(--green)"},
          {label:"Total Gallons",value:`${Number(totalGallons).toLocaleString(undefined,{minimumFractionDigits:1,maximumFractionDigits:1})} gal`,icon:"â›½",color:"#60A5FA"},
          {label:"Avg Price/Gallon",value:`$${Number(avgPPG).toFixed(3)}`,icon:"ğŸ“Š",color:"#FBBF24"},
          {label:"Fuel Entries",value:fuelLog.length,icon:"ğŸ“‹",color:"#A78BFA"},
        ].map(k=>(
          <div key={k.label} style={{background:"var(--bg2)",border:"1px solid var(--border)",borderRadius:12,padding:16}}>
            <div style={{fontSize:22,marginBottom:8}}>{k.icon}</div>
            <div style={{fontFamily:"var(--display)",fontSize:20,fontWeight:800,color:k.color}}>{k.value}</div>
            <div style={{fontSize:11,color:"var(--gray)",fontFamily:"var(--mono)",marginTop:4}}>{k.label}</div>
          </div>
        ))}
      </div>

      {/* Log Miles Form */}
      {showMiles&&(
        <form onSubmit={saveMiles} style={{background:"var(--bg2)",border:"1px solid var(--border)",borderRadius:12,padding:20,marginBottom:20}}>
          <div style={{fontFamily:"var(--display)",fontSize:15,fontWeight:700,marginBottom:16}}>ğŸ›£ Log Miles by State</div>
          <div style={{display:"grid",gridTemplateColumns:"repeat(3,1fr)",gap:12,marginBottom:12}}>
            <div>
              <div style={{fontSize:11,color:"var(--gray)",marginBottom:4,fontFamily:"var(--mono)"}}>DRIVER</div>
              <select value={milesForm.driver_name} onChange={e=>setMilesForm(p=>({...p,driver_name:e.target.value}))} style={{width:"100%"}} required>
                <option value="">Select Driver</option>
                {drivers.map(d=><option key={d.id} value={d.full_name||d.username}>{d.full_name||d.username}</option>)}
              </select>
            </div>
            <div>
              <div style={{fontSize:11,color:"var(--gray)",marginBottom:4,fontFamily:"var(--mono)"}}>VEHICLE</div>
              <input value={milesForm.vehicle} onChange={e=>setMilesForm(p=>({...p,vehicle:e.target.value}))} placeholder="TRK-001" style={{width:"100%"}} required/>
            </div>
            <div>
              <div style={{fontSize:11,color:"var(--gray)",marginBottom:4,fontFamily:"var(--mono)"}}>STATE</div>
              <select value={milesForm.state} onChange={e=>setMilesForm(p=>({...p,state:e.target.value}))} style={{width:"100%"}} required>
                {US_STATES.map(s=><option key={s} value={s}>{s}</option>)}
              </select>
            </div>
            <div>
              <div style={{fontSize:11,color:"var(--gray)",marginBottom:4,fontFamily:"var(--mono)"}}>MILES</div>
              <input type="number" step="0.1" value={milesForm.miles} onChange={e=>setMilesForm(p=>({...p,miles:e.target.value}))} placeholder="0.0" style={{width:"100%"}} required/>
            </div>
            <div>
              <div style={{fontSize:11,color:"var(--gray)",marginBottom:4,fontFamily:"var(--mono)"}}>DATE</div>
              <input type="date" value={milesForm.trip_date} onChange={e=>setMilesForm(p=>({...p,trip_date:e.target.value}))} style={{width:"100%"}} required/>
            </div>
            <div>
              <div style={{fontSize:11,color:"var(--gray)",marginBottom:4,fontFamily:"var(--mono)"}}>LOAD # (OPTIONAL)</div>
              <input value={milesForm.load_id} onChange={e=>setMilesForm(p=>({...p,load_id:e.target.value}))} placeholder="Load ID" style={{width:"100%"}}/>
            </div>
          </div>
          <div style={{display:"flex",gap:8}}>
            <button type="submit" className="btn btn-green" disabled={savingMiles}>{savingMiles?"Saving...":"Save Miles"}</button>
            <button type="button" className="btn btn-ghost" onClick={()=>setShowMiles(false)}>Cancel</button>
          </div>
        </form>
      )}

      {/* Add Fuel Form */}
      {showAdd&&(
        <form onSubmit={saveFuel} style={{background:"var(--bg2)",border:"1px solid var(--border)",borderRadius:12,padding:20,marginBottom:20}}>
          <div style={{fontFamily:"var(--display)",fontSize:15,fontWeight:700,marginBottom:16}}>â›½ Log Fuel Purchase</div>
          <div style={{display:"grid",gridTemplateColumns:"repeat(3,1fr)",gap:12,marginBottom:12}}>
            <div>
              <div style={{fontSize:11,color:"var(--gray)",marginBottom:4,fontFamily:"var(--mono)"}}>DRIVER</div>
              <select value={form.driver_name} onChange={e=>setForm(p=>({...p,driver_name:e.target.value}))} style={{width:"100%"}} required>
                <option value="">Select Driver</option>
                {drivers.map(d=><option key={d.id} value={d.full_name||d.username}>{d.full_name||d.username}</option>)}
              </select>
            </div>
            <div>
              <div style={{fontSize:11,color:"var(--gray)",marginBottom:4,fontFamily:"var(--mono)"}}>VEHICLE</div>
              <input value={form.vehicle} onChange={e=>setForm(p=>({...p,vehicle:e.target.value}))} placeholder="TRK-001" style={{width:"100%"}} required/>
            </div>
            <div>
              <div style={{fontSize:11,color:"var(--gray)",marginBottom:4,fontFamily:"var(--mono)"}}>STATE</div>
              <select value={form.state} onChange={e=>setForm(p=>({...p,state:e.target.value}))} style={{width:"100%"}} required>
                {US_STATES.map(s=><option key={s} value={s}>{s}</option>)}
              </select>
            </div>
            <div>
              <div style={{fontSize:11,color:"var(--gray)",marginBottom:4,fontFamily:"var(--mono)"}}>GALLONS</div>
              <input type="number" step="0.001" value={form.gallons} onChange={e=>setForm(p=>({...p,gallons:e.target.value}))} placeholder="0.000" style={{width:"100%"}} required/>
            </div>
            <div>
              <div style={{fontSize:11,color:"var(--gray)",marginBottom:4,fontFamily:"var(--mono)"}}>PRICE/GALLON</div>
              <input type="number" step="0.001" value={form.price_per_gallon} onChange={e=>setForm(p=>({...p,price_per_gallon:e.target.value}))} placeholder="0.000" style={{width:"100%"}} required/>
            </div>
            <div>
              <div style={{fontSize:11,color:"var(--gray)",marginBottom:4,fontFamily:"var(--mono)"}}>DATE</div>
              <input type="date" value={form.fuel_date} onChange={e=>setForm(p=>({...p,fuel_date:e.target.value}))} style={{width:"100%"}} required/>
            </div>
            <div>
              <div style={{fontSize:11,color:"var(--gray)",marginBottom:4,fontFamily:"var(--mono)"}}>ODOMETER</div>
              <input type="number" value={form.odometer} onChange={e=>setForm(p=>({...p,odometer:e.target.value}))} placeholder="Optional" style={{width:"100%"}}/>
            </div>
            <div>
              <div style={{fontSize:11,color:"var(--gray)",marginBottom:4,fontFamily:"var(--mono)"}}>VENDOR</div>
              <input value={form.vendor} onChange={e=>setForm(p=>({...p,vendor:e.target.value}))} placeholder="Pilot, TA, Love's..." style={{width:"100%"}}/>
            </div>
            <div>
              <div style={{fontSize:11,color:"var(--gray)",marginBottom:4,fontFamily:"var(--mono)"}}>FUEL TYPE</div>
              <select value={form.fuel_type} onChange={e=>setForm(p=>({...p,fuel_type:e.target.value}))} style={{width:"100%"}}>
                <option value="diesel">Diesel</option>
                <option value="gasoline">Gasoline</option>
                <option value="reefer">Reefer</option>
                <option value="def">DEF</option>
              </select>
            </div>
          </div>
          {form.gallons&&form.price_per_gallon&&(
            <div style={{background:"var(--green-glow)",border:"1px solid rgba(255,107,53,0.2)",borderRadius:8,padding:"10px 14px",marginBottom:12,fontSize:13,color:"var(--green)",fontFamily:"var(--mono)"}}>
              ğŸ’° Total: ${(parseFloat(form.gallons||0)*parseFloat(form.price_per_gallon||0)).toFixed(2)}
            </div>
          )}
          <div style={{display:"flex",gap:8}}>
            <button type="submit" className="btn btn-green" disabled={saving}>{saving?"Saving...":"Save Fuel Entry"}</button>
            <button type="button" className="btn btn-ghost" onClick={()=>setShowAdd(false)}>Cancel</button>
          </div>
        </form>
      )}

      {/* Tabs */}
      <div style={{display:"flex",gap:8,marginBottom:16}}>
        {[["dashboard","ğŸ“Š Dashboard"],["log","â›½ Fuel Log"],["ifta","ğŸ“‹ IFTA Report"],["analytics","ğŸ“ˆ Analytics"]].map(([id,label])=>(
          <button key={id} className="btn btn-ghost btn-sm" onClick={()=>{ setTab(id); if(id==="ifta")loadIFTA(); }}
            style={{background:tab===id?"var(--green-glow)":"transparent",color:tab===id?"var(--green)":"var(--gray)",borderColor:tab===id?"rgba(255,107,53,0.3)":"var(--border)"}}>
            {label}
          </button>
        ))}
      </div>

      {/* Dashboard Tab */}
      {tab==="dashboard"&&(
        <div>
          <div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:16}}>
            {/* By Vehicle */}
            <div style={{background:"var(--bg2)",border:"1px solid var(--border)",borderRadius:12,padding:20}}>
              <div style={{fontFamily:"var(--mono)",fontSize:11,color:"var(--gray)",letterSpacing:1,marginBottom:16}}>FUEL BY VEHICLE</div>
              {analytics?.by_vehicle?.length > 0 ? analytics.by_vehicle.map(v=>(
                <div key={v.vehicle} style={{display:"flex",justifyContent:"space-between",alignItems:"center",padding:"10px 0",borderBottom:"1px solid var(--border)"}}>
                  <div>
                    <div style={{fontSize:13,fontWeight:600}}>{v.vehicle}</div>
                    <div style={{fontSize:11,color:"var(--gray)",fontFamily:"var(--mono)"}}>{Number(v.total_gallons).toFixed(1)} gal Â· {v.fill_ups} fill-ups</div>
                  </div>
                  <div style={{fontSize:14,fontWeight:700,color:"var(--green)"}}>${Number(v.total_cost).toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2})}</div>
                </div>
              )) : <div style={{color:"var(--gray)",fontSize:13}}>No fuel data yet</div>}
            </div>
            {/* By State */}
            <div style={{background:"var(--bg2)",border:"1px solid var(--border)",borderRadius:12,padding:20}}>
              <div style={{fontFamily:"var(--mono)",fontSize:11,color:"var(--gray)",letterSpacing:1,marginBottom:16}}>TOP FUEL STATES</div>
              {analytics?.by_state?.length > 0 ? analytics.by_state.map(s=>(
                <div key={s.state} style={{display:"flex",justifyContent:"space-between",alignItems:"center",padding:"10px 0",borderBottom:"1px solid var(--border)"}}>
                  <div style={{display:"flex",alignItems:"center",gap:10}}>
                    <div style={{width:32,height:32,borderRadius:6,background:"var(--bg3)",display:"flex",alignItems:"center",justifyContent:"center",fontFamily:"var(--mono)",fontSize:11,fontWeight:700}}>{s.state}</div>
                    <div style={{fontSize:13}}>{s.state}</div>
                  </div>
                  <div style={{fontSize:14,fontWeight:700,color:"#60A5FA"}}>${Number(s.spend).toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2})}</div>
                </div>
              )) : <div style={{color:"var(--gray)",fontSize:13}}>No fuel data yet</div>}
            </div>
          </div>
        </div>
      )}

      {/* Fuel Log Tab */}
      {tab==="log"&&(
        <div style={{background:"var(--bg2)",border:"1px solid var(--border)",borderRadius:12,overflow:"hidden"}}>
          <table style={{width:"100%",borderCollapse:"collapse"}}>
            <thead>
              <tr style={{borderBottom:"1px solid var(--border)"}}>
                {["Date","Driver","Vehicle","State","Gallons","Price/Gal","Total","Vendor","Type"].map(h=>(
                  <th key={h} style={{padding:"12px 16px",textAlign:"left",fontSize:10,fontFamily:"var(--mono)",color:"var(--gray)",letterSpacing:1}}>{h}</th>
                ))}
              </tr>
            </thead>
            <tbody>
              {fuelLog.map(f=>(
                <tr key={f.id} style={{borderBottom:"1px solid var(--border)"}}
                  onMouseEnter={e=>e.currentTarget.style.background="var(--bg3)"}
                  onMouseLeave={e=>e.currentTarget.style.background="transparent"}>
                  <td style={{padding:"12px 16px",fontSize:12,fontFamily:"var(--mono)",color:"var(--gray)"}}>{f.fuel_date}</td>
                  <td style={{padding:"12px 16px",fontSize:13}}>{f.driver_name}</td>
                  <td style={{padding:"12px 16px",fontSize:12,fontFamily:"var(--mono)",color:"var(--green)"}}>{f.vehicle}</td>
                  <td style={{padding:"12px 16px"}}><span style={{padding:"2px 8px",background:"var(--bg3)",borderRadius:4,fontSize:11,fontFamily:"var(--mono)"}}>{f.state}</span></td>
                  <td style={{padding:"12px 16px",fontSize:12,fontFamily:"var(--mono)"}}>{Number(f.gallons).toFixed(3)}</td>
                  <td style={{padding:"12px 16px",fontSize:12,fontFamily:"var(--mono)"}}>${Number(f.price_per_gallon).toFixed(3)}</td>
                  <td style={{padding:"12px 16px",fontSize:12,fontFamily:"var(--mono)",color:"var(--green)",fontWeight:600}}>${Number(f.total_cost).toFixed(2)}</td>
                  <td style={{padding:"12px 16px",fontSize:12,color:"var(--gray)"}}>{f.vendor||"â€”"}</td>
                  <td style={{padding:"12px 16px"}}><span className="tag tag-gray">{f.fuel_type}</span></td>
                </tr>
              ))}
            </tbody>
          </table>
          {fuelLog.length===0&&<div style={{textAlign:"center",padding:"40px",color:"var(--gray)",fontSize:13}}>No fuel entries yet. Click + Log Fuel to start.</div>}
        </div>
      )}

      {/* IFTA Report Tab */}
      {tab==="ifta"&&(
        <div>
          <div style={{display:"flex",alignItems:"center",gap:12,marginBottom:16}}>
            <div>
              <div style={{fontSize:11,color:"var(--gray)",marginBottom:4,fontFamily:"var(--mono)"}}>QUARTER</div>
              <select value={quarter} onChange={e=>{setQuarter(parseInt(e.target.value));}} style={{width:120}}>
                <option value={1}>Q1 (Jan-Mar)</option>
                <option value={2}>Q2 (Apr-Jun)</option>
                <option value={3}>Q3 (Jul-Sep)</option>
                <option value={4}>Q4 (Oct-Dec)</option>
              </select>
            </div>
            <div>
              <div style={{fontSize:11,color:"var(--gray)",marginBottom:4,fontFamily:"var(--mono)"}}>YEAR</div>
              <select value={year} onChange={e=>setYear(parseInt(e.target.value))} style={{width:100}}>
                {[2024,2025,2026].map(y=><option key={y} value={y}>{y}</option>)}
              </select>
            </div>
            <div style={{marginTop:18,display:"flex",gap:8}}>
                <button className="btn btn-green" onClick={loadIFTA} disabled={iftaLoading}>{iftaLoading?"Calculating...":"Generate Report"}</button>
                {ifta&&<button className="btn btn-ghost" onClick={()=>window.open(`https://freightquick-app.onrender.com/api/ifta/export?company_id=${fqUser?.company_id||1}&quarter=${quarter}&year=${year}`)}>â¬‡ Export CSV</button>}
              </div>
          </div>

          {ifta&&(
            <div>
              {/* Summary */}
              <div style={{display:"grid",gridTemplateColumns:"repeat(4,1fr)",gap:12,marginBottom:16}}>
                {[
                  {label:"Total Miles",value:ifta.total_miles?.toLocaleString(),color:"#60A5FA"},
                  {label:"Total Gallons",value:Number(ifta.total_gallons).toFixed(3),color:"#FBBF24"},
                  {label:"Fleet MPG",value:ifta.fleet_mpg,color:"#4ADE80"},
                  {label:"Net Tax Due",value:`$${ifta.total_tax_due}`,color:ifta.total_tax_due>0?"#F87171":"#4ADE80"},
                ].map(k=>(
                  <div key={k.label} style={{background:"var(--bg2)",border:"1px solid var(--border)",borderRadius:12,padding:16,textAlign:"center"}}>
                    <div style={{fontFamily:"var(--display)",fontSize:22,fontWeight:800,color:k.color}}>{k.value}</div>
                    <div style={{fontSize:11,color:"var(--gray)",fontFamily:"var(--mono)",marginTop:4}}>{k.label}</div>
                  </div>
                ))}
              </div>

              {/* Jurisdiction Table */}
              <div style={{background:"var(--bg2)",border:"1px solid var(--border)",borderRadius:12,overflow:"hidden"}}>
                <div style={{padding:"14px 16px",borderBottom:"1px solid var(--border)",display:"flex",justifyContent:"space-between",alignItems:"center"}}>
                  <div style={{fontFamily:"var(--mono)",fontSize:11,color:"var(--gray)",letterSpacing:1}}>JURISDICTION BREAKDOWN â€” Q{ifta.quarter} {ifta.year}</div>
                  <div style={{fontSize:11,color:ifta.total_tax_due>0?"#F87171":"#4ADE80",fontFamily:"var(--mono)",fontWeight:700}}>
                    {ifta.total_tax_due>0?`NET DUE: $${ifta.total_tax_due}`:`NET CREDIT: $${Math.abs(ifta.total_tax_due)}`}
                  </div>
                </div>
                <table style={{width:"100%",borderCollapse:"collapse"}}>
                  <thead>
                    <tr style={{borderBottom:"1px solid var(--border)"}}>
                      {["State","Miles","Gal Purchased","Gal Consumed","Tax Rate","Tax Due/Credit","Status"].map(h=>(
                        <th key={h} style={{padding:"10px 16px",textAlign:"left",fontSize:10,fontFamily:"var(--mono)",color:"var(--gray)",letterSpacing:1}}>{h}</th>
                      ))}
                    </tr>
                  </thead>
                  <tbody>
                    {ifta.jurisdictions.map(j=>(
                      <tr key={j.state} style={{borderBottom:"1px solid var(--border)"}}
                        onMouseEnter={e=>e.currentTarget.style.background="var(--bg3)"}
                        onMouseLeave={e=>e.currentTarget.style.background="transparent"}>
                        <td style={{padding:"10px 16px",fontFamily:"var(--mono)",fontSize:13,fontWeight:700}}>{j.state}</td>
                        <td style={{padding:"10px 16px",fontSize:12,fontFamily:"var(--mono)"}}>{j.miles.toLocaleString()}</td>
                        <td style={{padding:"10px 16px",fontSize:12,fontFamily:"var(--mono)"}}>{j.gallons_purchased}</td>
                        <td style={{padding:"10px 16px",fontSize:12,fontFamily:"var(--mono)"}}>{j.gallons_consumed}</td>
                        <td style={{padding:"10px 16px",fontSize:12,fontFamily:"var(--mono)"}}>${j.tax_rate}</td>
                        <td style={{padding:"10px 16px",fontSize:12,fontFamily:"var(--mono)",color:j.tax_due>0?"#F87171":"#4ADE80",fontWeight:600}}>
                          {j.tax_due>0?`$${j.tax_due}`:`($${Math.abs(j.tax_due)})`}
                        </td>
                        <td style={{padding:"10px 16px"}}>
                          <span style={{padding:"2px 8px",borderRadius:4,fontSize:10,fontFamily:"var(--mono)",fontWeight:700,
                            background:j.status==="DUE"?"rgba(248,113,113,0.1)":"rgba(74,222,128,0.1)",
                            color:j.status==="DUE"?"#F87171":"#4ADE80"}}>
                            {j.status}
                          </span>
                        </td>
                      </tr>
                    ))}
                  </tbody>
                </table>
                {ifta.jurisdictions.length===0&&<div style={{textAlign:"center",padding:"40px",color:"var(--gray)",fontSize:13}}>No data for this quarter. Log fuel and miles to generate IFTA report.</div>}
              </div>
            </div>
          )}
          {!ifta&&!iftaLoading&&<div style={{textAlign:"center",padding:"40px",color:"var(--gray)",fontSize:13,background:"var(--bg2)",borderRadius:12,border:"1px solid var(--border)"}}>Select a quarter and year then click Generate Report</div>}
        </div>
      )}

      {/* Analytics Tab */}
      {tab==="analytics"&&(
        <div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:16}}>
          <div style={{background:"var(--bg2)",border:"1px solid var(--border)",borderRadius:12,padding:20}}>
            <div style={{fontFamily:"var(--mono)",fontSize:11,color:"var(--gray)",letterSpacing:1,marginBottom:16}}>COST PER VEHICLE</div>
            {analytics?.by_vehicle?.length>0 ? analytics.by_vehicle.map(v=>{
              const pct = totalSpend > 0 ? (v.total_cost/totalSpend)*100 : 0;
              return (
                <div key={v.vehicle} style={{marginBottom:16}}>
                  <div style={{display:"flex",justifyContent:"space-between",marginBottom:4}}>
                    <div style={{fontSize:13,fontWeight:600}}>{v.vehicle}</div>
                    <div style={{fontSize:12,fontFamily:"var(--mono)",color:"var(--green)"}}>${Number(v.total_cost).toFixed(2)}</div>
                  </div>
                  <div style={{height:6,background:"var(--bg3)",borderRadius:3}}>
                    <div style={{height:"100%",width:`${pct}%`,background:"var(--green)",borderRadius:3}}/>
                  </div>
                  <div style={{fontSize:10,color:"var(--gray)",fontFamily:"var(--mono)",marginTop:2}}>Avg ${Number(v.avg_ppg).toFixed(3)}/gal Â· {v.fill_ups} fill-ups</div>
                </div>
              );
            }) : <div style={{color:"var(--gray)",fontSize:13}}>No data yet</div>}
          </div>
          <div style={{background:"var(--bg2)",border:"1px solid var(--border)",borderRadius:12,padding:20}}>
            <div style={{fontFamily:"var(--mono)",fontSize:11,color:"var(--gray)",letterSpacing:1,marginBottom:16}}>SPEND BY STATE</div>
            {analytics?.by_state?.length>0 ? analytics.by_state.map(s=>{
              const pct = totalSpend > 0 ? (s.spend/totalSpend)*100 : 0;
              return (
                <div key={s.state} style={{marginBottom:12}}>
                  <div style={{display:"flex",justifyContent:"space-between",marginBottom:4}}>
                    <div style={{fontSize:13,fontWeight:600}}>{s.state}</div>
                    <div style={{fontSize:12,fontFamily:"var(--mono)",color:"#60A5FA"}}>${Number(s.spend).toFixed(2)}</div>
                  </div>
                  <div style={{height:6,background:"var(--bg3)",borderRadius:3}}>
                    <div style={{height:"100%",width:`${pct}%`,background:"#60A5FA",borderRadius:3}}/>
                  </div>
                </div>
              );
            }) : <div style={{color:"var(--gray)",fontSize:13}}>No data yet</div>}
          </div>
        </div>
      )}
    </div>
  );
}

// â”€â”€ SETTINGS VIEW â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function SettingsView() {
  const [form, setForm] = useState({
    company_name: fqUser?.company_name || "",
    address: "", city: "", state: "", zip_code: "",
    phone: "", email: fqUser?.email || "",
    dot_number: "", mc_number: "", tax_id: "",
    logo_base64: null
  });
  const [loading, setLoading] = useState(true);
  const [saving, setSaving] = useState(false);
  const [toast, setToast] = useState(null);
  const [logoPreview, setLogoPreview] = useState(null);

  useEffect(()=>{
    async function load() {
      const s = await apiFetch(`/settings/${fqUser?.company_id}`);
      if(s) {
        setForm(prev=>({...prev,...s}));
        if(s.logo_base64) setLogoPreview(s.logo_base64);
      }
      setLoading(false);
    }
    load();
  },[]);

  function handleLogo(e) {
    const file = e.target.files[0];
    if(!file) return;
    if(file.size > 500000) { setToast("âŒ Logo must be under 500KB"); setTimeout(()=>setToast(null),3000); return; }
    const reader = new FileReader();
    reader.onload = (ev) => {
      setLogoPreview(ev.target.result);
      setForm(p=>({...p, logo_base64: ev.target.result}));
    };
    reader.readAsDataURL(file);
  }

  async function saveSettings(e) {
    e.preventDefault();
    setSaving(true);
    const res = await apiFetch("/settings", {
      method: "POST",
      body: JSON.stringify({...form, company_id: fqUser?.company_id})
    });
    setSaving(false);
    if(res?.message) {
      setToast("âœ… Settings saved!");
    } else {
      setToast("âŒ Error saving settings");
    }
    setTimeout(()=>setToast(null), 3000);
  }

  if(loading) return <div style={{padding:40,color:"var(--gray)"}}>Loading...</div>;

  return (
    <div style={{flex:1,overflowY:"auto",padding:24}}>
      {toast&&<div style={{background:toast.includes("âœ…")?"rgba(0,200,0,0.1)":"rgba(200,0,0,0.1)",border:`1px solid ${toast.includes("âœ…")?"rgba(0,200,0,0.3)":"rgba(200,0,0,0.3)"}`,borderRadius:8,padding:"10px 16px",marginBottom:16,fontSize:13,color:toast.includes("âœ…")?"var(--green)":"var(--red)"}}>{toast}</div>}

      <div style={{marginBottom:24}}>
        <div style={{fontFamily:"var(--mono)",fontSize:11,color:"var(--green)",letterSpacing:2,textTransform:"uppercase",marginBottom:6}}>Company</div>
        <div style={{fontFamily:"var(--display)",fontSize:22,fontWeight:800,letterSpacing:-0.8}}>Settings</div>
      </div>

      <form onSubmit={saveSettings}>
        {/* Logo */}
        <div style={{background:"var(--bg2)",border:"1px solid var(--border)",borderRadius:12,padding:20,marginBottom:16}}>
          <div style={{fontFamily:"var(--mono)",fontSize:11,color:"var(--gray)",letterSpacing:1,textTransform:"uppercase",marginBottom:16}}>Company Logo</div>
          <div style={{display:"flex",alignItems:"center",gap:20}}>
            <div style={{width:80,height:80,borderRadius:12,background:"var(--bg3)",border:"1px solid var(--border)",display:"flex",alignItems:"center",justifyContent:"center",overflow:"hidden"}}>
              {logoPreview ? <img src={logoPreview} style={{width:"100%",height:"100%",objectFit:"contain"}}/> : <span style={{fontSize:32}}>ğŸ¢</span>}
            </div>
            <div>
              <input type="file" accept="image/*" onChange={handleLogo} id="logo-upload" style={{display:"none"}}/>
              <label htmlFor="logo-upload" className="btn btn-ghost" style={{cursor:"pointer",display:"inline-block"}}>Upload Logo</label>
              <div style={{fontSize:11,color:"var(--gray)",marginTop:6}}>PNG, JPG up to 500KB. Will appear on all documents.</div>
            </div>
          </div>
        </div>

        {/* Company Info */}
        <div style={{background:"var(--bg2)",border:"1px solid var(--border)",borderRadius:12,padding:20,marginBottom:16}}>
          <div style={{fontFamily:"var(--mono)",fontSize:11,color:"var(--gray)",letterSpacing:1,textTransform:"uppercase",marginBottom:16}}>Company Information</div>
          <div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:12}}>
            {[
              ["company_name","Company Name"],
              ["phone","Phone Number"],
              ["email","Email"],
              ["address","Street Address"],
              ["city","City"],
              ["state","State"],
              ["zip_code","ZIP Code"],
            ].map(([k,lbl])=>(
              <div key={k}>
                <div style={{fontSize:11,color:"var(--gray)",marginBottom:4,fontFamily:"var(--mono)"}}>{lbl.toUpperCase()}</div>
                <input value={form[k]||""} onChange={e=>setForm(p=>({...p,[k]:e.target.value}))} placeholder={lbl} style={{width:"100%"}}/>
              </div>
            ))}
          </div>
        </div>

        {/* DOT/MC Info */}
        <div style={{background:"var(--bg2)",border:"1px solid var(--border)",borderRadius:12,padding:20,marginBottom:16}}>
          <div style={{fontFamily:"var(--mono)",fontSize:11,color:"var(--gray)",letterSpacing:1,textTransform:"uppercase",marginBottom:16}}>Regulatory Information</div>
          <div style={{display:"grid",gridTemplateColumns:"1fr 1fr 1fr",gap:12}}>
            {[
              ["dot_number","DOT Number"],
              ["mc_number","MC Number"],
              ["tax_id","Tax ID / EIN"],
            ].map(([k,lbl])=>(
              <div key={k}>
                <div style={{fontSize:11,color:"var(--gray)",marginBottom:4,fontFamily:"var(--mono)"}}>{lbl.toUpperCase()}</div>
                <input value={form[k]||""} onChange={e=>setForm(p=>({...p,[k]:e.target.value}))} placeholder={lbl} style={{width:"100%"}}/>
              </div>
            ))}
          </div>
        </div>

        <button type="submit" className="btn btn-green" disabled={saving}>
          {saving?"Saving...":"ğŸ’¾ Save Settings"}
        </button>
      </form>
    </div>
  );
}

// â”€â”€ BILLING VIEW â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function BillingView() {
  const [plans] = useState([
    {name:"Starter",drivers:5,price:145,per_driver:29,description:"Up to 5 drivers"},
    {name:"Growth",drivers:15,price:435,per_driver:29,description:"Up to 15 drivers"},
    {name:"Fleet",drivers:50,price:1450,per_driver:29,description:"Up to 50 drivers"},
  ]);
  const [loading, setLoading] = useState(null);
  const [toast, setToast] = useState(null);

  async function subscribe(plan) {
    setLoading(plan.name);
    try {
      const res = await apiFetch("/stripe/create-checkout", {
        method:"POST",
        body:JSON.stringify({
          company_id: fqUser?.company_id,
          company_name: fqUser?.company_name,
          email: fqUser?.email,
          driver_count: plan.drivers
        })
      });
      if(res?.checkout_url) {
        window.location.href = res.checkout_url;
      } else {
        setToast("âŒ Error creating checkout. Please try again.");
        setTimeout(()=>setToast(null), 3000);
      }
    } catch(e) {
      setToast("âŒ Connection error. Please try again.");
      setTimeout(()=>setToast(null), 3000);
    }
    setLoading(null);
  }

  const urlParams = new URLSearchParams(window.location.search);
  const paymentStatus = urlParams.get("payment");

  return (
    <div style={{flex:1,overflowY:"auto",padding:24}}>
      {toast && <div style={{background:"var(--red)",color:"#fff",padding:"10px 20px",fontFamily:"var(--mono)",fontSize:12,fontWeight:600,textAlign:"center",marginBottom:16,borderRadius:8}}>{toast}</div>}

      {paymentStatus==="success" && (
        <div style={{background:"rgba(0,200,0,0.1)",border:"1px solid rgba(0,200,0,0.3)",borderRadius:12,padding:20,marginBottom:24,textAlign:"center"}}>
          <div style={{fontSize:32,marginBottom:8}}>ğŸ‰</div>
          <div style={{fontFamily:"var(--display)",fontSize:18,fontWeight:700,marginBottom:4}}>Payment Successful!</div>
          <div style={{fontSize:13,color:"var(--gray)"}}>Your subscription is now active. Welcome to FreightQuick!</div>
        </div>
      )}

      {paymentStatus==="cancelled" && (
        <div style={{background:"rgba(255,92,92,0.1)",border:"1px solid rgba(255,92,92,0.3)",borderRadius:12,padding:20,marginBottom:24,textAlign:"center"}}>
          <div style={{fontSize:13,color:"var(--gray)"}}>Payment cancelled. Choose a plan below to get started.</div>
        </div>
      )}

      <div style={{marginBottom:24}}>
        <div style={{fontFamily:"var(--mono)",fontSize:11,color:"var(--green)",letterSpacing:2,textTransform:"uppercase",marginBottom:6}}>Subscription</div>
        <div style={{fontFamily:"var(--display)",fontSize:22,fontWeight:800,letterSpacing:-0.8}}>Choose Your Plan</div>
        <div style={{fontSize:13,color:"var(--gray)",marginTop:6}}>$25 per driver per month. Cancel anytime.</div>
      </div>

      <div style={{display:"grid",gridTemplateColumns:"repeat(3,1fr)",gap:20,marginBottom:32}}>
        {plans.map(plan=>(
          <div key={plan.name} style={{background:"var(--bg2)",border:`1px solid ${plan.name==="Growth"?"var(--green)":"var(--border)"}`,borderRadius:16,padding:24,position:"relative",display:"flex",flexDirection:"column"}}>
            {plan.name==="Growth" && (
              <div style={{position:"absolute",top:-12,left:"50%",transform:"translateX(-50%)",background:"var(--green)",color:"#000",padding:"4px 16px",borderRadius:20,fontSize:10,fontWeight:700,fontFamily:"var(--mono)",whiteSpace:"nowrap"}}>MOST POPULAR</div>
            )}
            <div style={{fontFamily:"var(--display)",fontSize:18,fontWeight:800,marginBottom:4}}>{plan.name}</div>
            <div style={{fontSize:12,color:"var(--gray)",marginBottom:16}}>{plan.description}</div>
            <div style={{marginBottom:16}}>
              <span style={{fontFamily:"var(--display)",fontSize:36,fontWeight:800,color:"var(--green)"}}>${plan.price}</span>
              <span style={{fontSize:12,color:"var(--gray)"}}>/month</span>
            </div>
            <div style={{fontSize:12,color:"var(--gray)",fontFamily:"var(--mono)",marginBottom:20}}>${plan.per_driver}/driver Ã— {plan.drivers} drivers</div>
            <div style={{display:"flex",flexDirection:"column",gap:8,marginBottom:24,flex:1}}>
              {["Full dispatch management","DOT compliance tracking","Driver settlements & PDF","Fleet insurance tracking","Vehicle inspections","Email support"].map(f=>(
                <div key={f} style={{display:"flex",alignItems:"center",gap:8,fontSize:12}}>
                  <span style={{color:"var(--green)"}}>âœ“</span>{f}
                </div>
              ))}
            </div>
            <button className="btn btn-green" style={{width:"100%",justifyContent:"center",padding:"12px",fontSize:13}} onClick={()=>subscribe(plan)} disabled={loading===plan.name}>
              {loading===plan.name?"Processing...":"Subscribe Now"}
            </button>
          </div>
        ))}
      </div>

      <div style={{background:"var(--bg2)",border:"1px solid var(--border)",borderRadius:12,padding:20}}>
        <div style={{fontFamily:"var(--mono)",fontSize:11,color:"var(--gray)",letterSpacing:1,marginBottom:12}}>ACCOUNT INFO</div>
        <div style={{display:"grid",gridTemplateColumns:"repeat(3,1fr)",gap:16}}>
          <div><div style={{fontSize:11,color:"var(--gray)",marginBottom:4}}>COMPANY</div><div style={{fontSize:13,fontWeight:600}}>{fqUser?.company_name}</div></div>
          <div><div style={{fontSize:11,color:"var(--gray)",marginBottom:4}}>EMAIL</div><div style={{fontSize:13}}>{fqUser?.email}</div></div>
          <div><div style={{fontSize:11,color:"var(--gray)",marginBottom:4}}>PLAN</div><div style={{fontSize:13,fontWeight:600,color:"var(--green)"}}>Test Mode</div></div>
        </div>
      </div>
    </div>
  );
}
// â”€â”€ COMPANIES VIEW (SUPERADMIN) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function CompaniesView() {
  const [companies, setCompanies] = useState([]);
  const [loading, setLoading] = useState(true);

  useEffect(()=>{ loadCompanies(); },[]);

  async function loadCompanies() {
    const data = await apiFetch("/superadmin/companies");
    if(data) setCompanies(data);
    setLoading(false);
  }

  return (
    <div style={{flex:1,overflowY:"auto",padding:24}}>
      <div style={{marginBottom:24}}>
        <div style={{fontFamily:"var(--mono)",fontSize:11,color:"var(--green)",letterSpacing:2,textTransform:"uppercase",marginBottom:6}}>Superadmin</div>
        <div style={{fontFamily:"var(--display)",fontSize:22,fontWeight:800,letterSpacing:-0.8}}>All Companies</div>
      </div>

      <div style={{display:"grid",gridTemplateColumns:"repeat(3,1fr)",gap:14,marginBottom:24}}>
        <KpiCard label="Total Companies" value={companies.length} sub="Registered on platform"/>
        <KpiCard label="Total Users" value={companies.reduce((a,c)=>a+c.total_users,0)} sub="Across all companies"/>
        <KpiCard label="Total Drivers" value={companies.reduce((a,c)=>a+c.drivers,0)} sub="All drivers" color="var(--green)"/>
      </div>

      <div style={{background:"var(--bg2)",border:"1px solid var(--border)",borderRadius:12,overflow:"hidden"}}>
        <table style={{width:"100%",borderCollapse:"collapse"}}>
          <thead>
            <tr style={{borderBottom:"1px solid var(--border)"}}>
              {["Company","DOT Number","Email","Managers","Drivers","Joined"].map(h=>(
                <th key={h} style={{padding:"12px 16px",textAlign:"left",fontSize:10,fontFamily:"var(--mono)",color:"var(--gray)",letterSpacing:1,textTransform:"uppercase"}}>{h}</th>
              ))}
            </tr>
          </thead>
          <tbody>
            {companies.map(c=>(
              <tr key={c.id} style={{borderBottom:"1px solid var(--border)"}}
                onMouseEnter={e=>e.currentTarget.style.background="var(--bg3)"}
                onMouseLeave={e=>e.currentTarget.style.background="transparent"}>
                <td style={{padding:"12px 16px"}}>
                  <div style={{fontWeight:600,fontSize:13}}>{c.company_name}</div>
                  <div style={{fontSize:11,color:"var(--gray)",fontFamily:"var(--mono)"}}>ID: {c.id}</div>
                </td>
                <td style={{padding:"12px 16px",fontFamily:"var(--mono)",fontSize:12,color:"var(--gray)"}}>{c.dot_number||"â€”"}</td>
                <td style={{padding:"12px 16px",fontSize:12,color:"var(--gray)"}}>{c.email}</td>
                <td style={{padding:"12px 16px"}}><span className="tag tag-blue">{c.managers}</span></td>
                <td style={{padding:"12px 16px"}}><span className="tag tag-green">{c.drivers}</span></td>
                <td style={{padding:"12px 16px",fontSize:12,fontFamily:"var(--mono)",color:"var(--gray)"}}>{c.created_at?.slice(0,10)}</td>
              </tr>
            ))}
          </tbody>
        </table>
        {loading&&<div style={{textAlign:"center",padding:"40px",color:"var(--gray)",fontSize:13}}>Loading companies...</div>}
        {!loading&&companies.length===0&&<div style={{textAlign:"center",padding:"40px",color:"var(--gray)",fontSize:13}}>No companies registered yet.</div>}
      </div>
    </div>
  );
}

// â”€â”€ MOBILE NAV â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function MobileNav({active, setActive}) {
  const allowedNav = NAV.filter(n=>n.roles.includes(fqUser?.role));
  const topNav = allowedNav.slice(0, 5);
  return (
    <div className="mobile-nav" style={{position:"fixed",bottom:0,left:0,right:0,background:"var(--bg2)",borderTop:"1px solid var(--border)",zIndex:100,padding:"6px 0",paddingBottom:"env(safe-area-inset-bottom)"}}>
      <div style={{display:"flex",justifyContent:"space-around",alignItems:"center"}}>
        {topNav.map(item=>(
          <button key={item.id} onClick={()=>setActive(item.id)}
            style={{display:"flex",flexDirection:"column",alignItems:"center",gap:2,background:"none",border:"none",cursor:"pointer",padding:"4px 8px",color:active===item.id?"var(--green)":"var(--gray)",minWidth:50}}>
            <span style={{fontSize:20}}>{item.icon}</span>
            <span style={{fontSize:9,fontFamily:"var(--mono)",letterSpacing:0.5}}>{item.label}</span>
          </button>
        ))}
        <button onClick={()=>setActive("more")}
          style={{display:"flex",flexDirection:"column",alignItems:"center",gap:2,background:"none",border:"none",cursor:"pointer",padding:"4px 8px",color:active==="more"?"var(--green)":"var(--gray)",minWidth:50}}>
          <span style={{fontSize:20}}>â˜°</span>
          <span style={{fontSize:9,fontFamily:"var(--mono)",letterSpacing:0.5}}>More</span>
        </button>
      </div>
    </div>
  );
}

// â”€â”€ MOBILE MORE MENU â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function MobileMoreMenu({active, setActive}) {
  const allowedNav = NAV.filter(n=>n.roles.includes(fqUser?.role));
  const moreNav = allowedNav.slice(5);
  return (
    <div style={{padding:16,paddingBottom:80}}>
      <div style={{fontFamily:"var(--mono)",fontSize:11,color:"var(--gray)",letterSpacing:2,marginBottom:16}}>MORE MODULES</div>
      {moreNav.map(item=>(
        <div key={item.id} onClick={()=>setActive(item.id)}
          style={{display:"flex",alignItems:"center",gap:14,padding:"14px 16px",marginBottom:8,borderRadius:10,cursor:"pointer",background:active===item.id?"var(--green-glow)":"var(--bg2)",border:`1px solid ${active===item.id?"rgba(255,107,53,0.3)":"var(--border)"}`}}>
          <span style={{fontSize:24}}>{item.icon}</span>
          <span style={{fontSize:14,fontWeight:600}}>{item.label}</span>
        </div>
      ))}
      <div style={{marginTop:20,padding:"14px 16px",borderRadius:10,background:"var(--bg2)",border:"1px solid var(--border)"}}>
        <div style={{fontSize:13,fontWeight:600,marginBottom:4}}>{fqUser?.full_name}</div>
        <div style={{fontSize:11,color:"var(--gray)",fontFamily:"var(--mono)",marginBottom:12}}>{fqUser?.role} Â· {fqUser?.company_name}</div>
        <button className="btn btn-ghost btn-sm" style={{width:"100%",justifyContent:"center"}} onClick={()=>{localStorage.removeItem("fq_user");window.location.href="auth.html";}}>Logout</button>
      </div>
    </div>
  );
}
// â”€â”€ TOP BAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function TopBar({view}) {
  const labels = {analytics:"Analytics Overview",dispatch:"Dispatch Management",loads:"Load Management",drivers:"Driver Management",routes:"Route Optimization"};
  return (
    <div style={{padding:"12px 24px",borderBottom:"1px solid var(--border)",display:"flex",alignItems:"center",justifyContent:"space-between",flexShrink:0,background:"var(--bg)"}}>
      <div style={{fontFamily:"var(--mono)",fontSize:11,color:"var(--gray)",letterSpacing:1}}>FREIGHTQUIK / {labels[view]?.toUpperCase()}</div>
      <div style={{display:"flex",alignItems:"center",gap:10}}>
        <div style={{display:"flex",alignItems:"center",gap:6,padding:"5px 10px",background:"var(--green-glow)",border:"1px solid rgba(255,107,53,0.2)",borderRadius:6}}>
          <div style={{width:6,height:6,borderRadius:"50%",background:"var(--green)",animation:"pulse 2s infinite"}}></div>
          <span style={{fontFamily:"var(--mono)",fontSize:10,color:"var(--green)"}}>LIVE</span>
        </div>
        <div style={{fontSize:12,color:"var(--gray)",fontFamily:"var(--mono)"}}>
          {new Date().toLocaleTimeString("en-US",{hour:"2-digit",minute:"2-digit"})}
        </div>
      </div>
      <style>{`@keyframes pulse{0%,100%{opacity:1}50%{opacity:0.4}}`}</style>
    </div>
  );
}

// â”€â”€ APP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function App() {
  const [view,setView] = useState(DEFAULT_VIEW);
  const [drivers,setDrivers] = useState(MOCK.drivers);
  const [loads,setLoads] = useState(MOCK.loads);
  const [analytics,setAnalytics] = useState(MOCK.analytics);

   const refresh = useCallback(async()=>{
    const [d,l,a] = await Promise.all([apiFetch("/drivers"),apiFetch("/loads"),apiFetch("/analytics")]);
    if(d) setDrivers(d);
    if(l) setLoads(l);
    if(a) setAnalytics(a);
    const trial = await apiFetch(`/trial/status/${fqUser?.company_id}`);
    if(trial) setTrialStatus(trial);
  },[]);

  useEffect(()=>{ refresh(); },[]);
  const [trialStatus, setTrialStatus] = useState(null);
  return (
    <div style={{display:"flex",flexDirection:"column",height:"100vh",overflow:"hidden"}}>
      {trialStatus?.status==="trial"&&(
        <div style={{background:"rgba(255,107,53,0.15)",borderBottom:"1px solid rgba(255,107,53,0.3)",padding:"8px 24px",display:"flex",alignItems:"center",justifyContent:"space-between",flexShrink:0}}>
          <div style={{fontSize:12,color:"var(--green)",fontFamily:"var(--mono)"}}>âš¡ FREE TRIAL â€” {trialStatus.days_left} days remaining. No credit card needed.</div>
          <button className="btn btn-green btn-sm" onClick={()=>setView("billing")}>Subscribe Now</button>
        </div>
      )}
      {trialStatus?.status==="expired"&&(
        <div style={{background:"rgba(255,92,92,0.15)",borderBottom:"1px solid rgba(255,92,92,0.3)",padding:"8px 24px",display:"flex",alignItems:"center",justifyContent:"space-between",flexShrink:0}}>
          <div style={{fontSize:12,color:"var(--red)",fontFamily:"var(--mono)"}}>âš  TRIAL EXPIRED â€” Subscribe to continue using FreightQuik</div>
          <button className="btn btn-green btn-sm" onClick={()=>setView("billing")}>Subscribe Now</button>
        </div>
      )}
      <div style={{display:"flex",flex:1,overflow:"hidden"}}>
      <Sidebar active={view} setActive={setView}/>
      <div style={{flex:1,display:"flex",flexDirection:"column",overflow:"hidden"}}>
        <TopBar view={view}/>
        <MobileNav active={view} setActive={setView}/>
        <div style={{flex:1,overflow:"hidden",display:"flex",flexDirection:"column"}}>
        {view==="analytics"&&<AnalyticsView data={analytics}/>}
        {view==="dispatch"&&<DispatchView drivers={drivers} loads={loads} onAssign={refresh}/>}
        {view==="loads"&&<LoadsView loads={loads} onRefresh={refresh}/>}
        {view==="drivers"&&<DriversView drivers={drivers} onRefresh={refresh}/>}
        {view==="routes"&&<RoutesView drivers={drivers} loads={loads}/>}
        {view==="compliance"&&<ComplianceView drivers={drivers}/>}
        {view==="truckpay"&&<TruckPayView drivers={drivers}/>}
        {view==="insurance"&&<InsuranceView/>}
        {view==="companies"&&<CompaniesView/>}
        {view==="inspection"&&<InspectionView drivers={drivers}/>}
        {view==="billing"&&<BillingView/>}
        {view==="settings"&&<SettingsView/>}
        {view==="ifta"&&<FuelIFTAView drivers={drivers}/>}
        {view==="maintenance"&&<MaintenanceView/>}
        {view==="fuel"&&<FuelManagerView drivers={drivers}/>}
       {view==="more"&&<MobileMoreMenu active={view} setActive={setView}/>}
        </div>
      </div>
    </div>
    </div>
  );
}
ReactDOM.createRoot(document.getElementById("root")).render(<App/>);
</script>
</body>
</html>
